# AutoTrade 시스템 분석 및 개선 계획

**날짜**: 2025-11-05
**분석 대상**: main.py 실행 로그 (13:22:33 사이클 #1-3)

---

## 🔴 발견된 Critical 문제점

### 1. Deep Scan 데이터 누락 (사이클 #2, #3)

**증상**:
```
[사이클 #1] ✅ 정상
[DEBUG 체결강도] 005930: execution_intensity=96.13 (type=<class 'float'>)
[DEBUG 프로그램] 005930: program_net_buy=83953000 (type=<class 'int'>)

[사이클 #2, #3] ❌ 실패
[DEBUG 체결강도] 005930: execution_intensity=None (type=<class 'NoneType'>)
[DEBUG 프로그램] 005930: program_net_buy=None (type=<class 'NoneType'>)
```

**원인**:
- API rate limiting으로 추정 (첫 번째 스캔 후 후속 호출 실패)
- Deep Scan 데이터 캐싱 미적용
- API 호출 간 delay 부족

**영향**:
- 사이클 #2, #3의 모든 종목이 체결강도=0, 프로그램=0 처리
- 종합 점수 25-32%로 급락 (정상 59% → 32%)
- 매수 기회 상실 (좋은 종목도 점수 부족으로 탈락)

**해결 방안**:
1. Deep Scan 결과 캐싱 (5분 TTL)
2. API 호출 간 0.5초 delay 추가
3. 실패 시 이전 캐시 사용 (5분 이내)

---

### 2. 점수 계산 로직 문제

**현재 상황**:
```python
# 사이클 #1: 케이이엠텍
종합: 263점 (60%) → ✅ 매수 조건 충족
- 거래량:60, 가격:60, 기관:10, 호가:40, 체결:20, 증권사:7, 프로그램:0

# 사이클 #2: 노타
종합: 139점 (32%) → ❌ 매수 조건 미충족 (데이터 누락으로 인한 저평가)
- 거래량:48, 가격:60, 기관:0, 호가:0, 체결:0, 증권사:0, 프로그램:0
```

**문제점**:
- Deep Scan 실패 시 0점 처리로 종합 점수 급락
- 거래량+가격 모멘텀이 충분해도 매수 안 됨
- 실제로는 좋은 종목일 수 있는데 데이터 누락으로 누락

**해결 방안**:
1. **부분 점수 시스템**: 데이터 없으면 평균값 사용
2. **가중치 동적 조정**: 사용 가능한 지표에 가중치 재분배
3. **최소 점수 하향**: 거래량+가격만으로도 50% 달성 가능하도록

---

### 3. 가상매매 거래 기록 부족

**현재**:
```
[공격적]
  거래: 2건 (승: 1, 패: 1)
  승률: 50.0%
```

**문제점**:
- 언제 매수/매도했는지 알 수 없음
- 어떤 종목을 거래했는지 불명확
- 손익 발생 시점 추적 불가
- 전략 분석 어려움

**개선안**:
```
[공격적] 거래 내역:
  1. 2025-11-05 09:15:23 [매수] 삼성전자(005930) 10주 @ 100,000원 = 1,000,000원
  2. 2025-11-05 11:32:45 [매도] 삼성전자(005930) 10주 @ 105,000원 = 1,050,000원 (+5.0%, +50,000원) ✅
  3. 2025-11-05 13:20:11 [매수] 케이이엠텍(106080) 107주 @ 1,856원 = 198,592원
```

---

### 4. 웹소켓 구독 기능 미사용

**로그 분석**:
```
✅ WebSocket 연결 성공
✅ WebSocket 로그인 성공
❌ 이후 실시간 구독 활동 없음
```

**현재 상태**:
- 웹소켓 연결만 되어 있고 실제 구독 안 함
- 실시간 체결/호가 데이터 수신 안 됨
- REST API로만 데이터 조회 (느림, rate limit 문제)

**웹소켓 구독 기능 정리**:

#### A. 현재가 구독 (KA10003)
```python
{
    "trnm": "KA10003",  # 주식 현재가
    "stk_cd_list": ["005930", "000660"],  # 구독할 종목 리스트
    "stex_tp": "KRX"
}
```
**활용 시점**:
- 보유 종목의 실시간 가격 모니터링
- 매수 후 즉시 구독 시작
- 매도 조건 도달 시 즉시 알림

#### B. 호가 구독 (KA10004)
```python
{
    "trnm": "KA10004",  # 주식 호가
    "stk_cd_list": ["005930"],
    "stex_tp": "KRX"
}
```
**활용 시점**:
- 매수 검토 중인 종목 (AI 검토 후)
- 매도 가능 가격대 확인

#### C. 체결 구독 (KA10005)
```python
{
    "trnm": "KA10005",  # 주식 체결
    "stk_cd_list": ["005930"],
    "stex_tp": "KRX"
}
```
**활용 시점**:
- 거래량 급등 모니터링
- 체결 강도 실시간 추적

**구현 전략**:
1. **보유 종목**: 현재가 + 호가 구독 (자동)
2. **AI 검토 중**: 호가 + 체결 구독 (5분)
3. **워치리스트**: 현재가만 구독 (지속)

---

## 🟡 수익 극대화 로직 개선

### 현재 문제점

**가상매매 성과 (사이클 #1)**:
```
[공격적]: -10.38% 📉 (2건, 승률 50%)
[보수적]: -9.93% 📉 (3건, 승률 33%)
[균형]: -12.67% 📉 (2건, 승률 50%)
```

**문제 분석**:
1. **손절 타이밍 늦음**: -10% 이상 손실 발생
2. **익절 조건 부재**: 수익 나도 계속 보유 → 하락 시 손실 전환
3. **진입 타이밍 불량**: 급등 후 추격 매수 → 고점 진입

### 개선 방안

#### 1. 동적 손절/익절 시스템
```python
# 현재 (고정)
STOP_LOSS = -5%
TAKE_PROFIT = +10%

# 개선 (동적)
if 변동성 < 3%:
    STOP_LOSS = -3%
    TAKE_PROFIT = +5%  # 보수적
elif 변동성 > 10%:
    STOP_LOSS = -7%
    TAKE_PROFIT = +15%  # 공격적
```

#### 2. 트레일링 스톱
```python
# 최고가 대비 하락률로 익절
if current_profit > +5%:
    if current_price < max_price * 0.97:  # 최고가 대비 -3%
        sell("트레일링 스톱")
```

#### 3. 분할 익절
```python
# AI 분할매수 전략에 맞춰 분할 익절
if profit > +5%:
    sell_quantity = quantity * 0.3  # 30% 익절
if profit > +10%:
    sell_quantity = quantity * 0.5  # 추가 50% 익절
if profit > +15%:
    sell_all()  # 전량 익절
```

#### 4. 시간대별 전략
```python
# 09:00-09:30: 장 초반 변동성 → 관망
# 09:30-14:30: 정규 매매
# 14:30-15:20: 익절 우선 (당일 마감)
# 15:20-15:30: 손절 정리
# 15:30-20:00: NXT 시간외 (신규 진입 제한)
```

#### 5. 리스크 관리 강화
```python
# 현재
max_position_size = calculate_based_on_cash()

# 개선
max_position_size = min(
    calculate_based_on_cash(),
    calculate_based_on_volatility(stock),  # 변동성 고려
    calculate_based_on_score(score)  # 점수 고려
)

# 예: 점수 60% = 최대 투자금의 60%만 사용
```

---

## 📋 개선 우선순위

### 🔴 P0 (즉시)
1. **Deep Scan 캐싱** - API rate limit 회피
2. **웹소켓 구독 활성화** - 실시간 데이터 수신
3. **가상매매 timestamp** - 거래 추적 가능

### 🟡 P1 (이번 주)
4. **점수 계산 로직 개선** - 부분 점수 시스템
5. **동적 손절/익절** - 수익률 개선
6. **트레일링 스톱** - 수익 보호

### 🟢 P2 (다음 주)
7. **분할 익절** - 리스크 분산
8. **시간대별 전략** - 시장 특성 반영
9. **리스크 관리 강화** - 안정성 향상

---

## 🎯 기대 효과

### Deep Scan 캐싱 적용 시
- API 호출 90% 감소
- 모든 사이클에서 정확한 점수 계산
- 매수 기회 3배 증가 예상

### 웹소켓 활성화 시
- 실시간 가격 모니터링 (0.5초 지연)
- 손절/익절 타이밍 개선
- API rate limit 문제 해결

### 동적 손익 관리 시
- 수익률 +15% → +25% 개선 예상
- 손실률 -10% → -5% 개선 예상
- 승률 50% → 65% 개선 예상

---

## 📊 웹소켓 구독 시나리오

### 시나리오 1: 신규 매수 시
```
1. AI 검토 → BUY 결정
2. 즉시 호가 구독 (KA10004) - 최적 가격 확인
3. 매수 주문 실행
4. 현재가 + 체결 구독 (KA10003, KA10005) - 실시간 모니터링
5. 손절/익절 조건 도달 시 즉시 매도
```

### 시나리오 2: 보유 종목 모니터링
```
1. 보유 종목 자동 현재가 구독
2. 1분마다 수익률 계산
3. 트레일링 스톱 체크
4. 조건 충족 시 즉시 매도 주문
```

### 시나리오 3: 시장 스캔 중
```
1. 거래량 급등 종목 발견
2. 해당 종목 체결 구독 (KA10005) - 5분간
3. 체결 강도 실시간 계산
4. 조건 충족 시 Deep Scan 수행
5. AI 검토 후 매수 결정
```

---

## 💻 구현 코드 위치

### 1. Deep Scan 캐싱
**파일**: `strategies/deep_scan.py`
**함수**: `perform_deep_scan()`
**추가**: Redis 또는 메모리 캐시 (5분 TTL)

### 2. 웹소켓 구독 관리
**파일**: `utils/websocket_manager.py` (신규 생성)
**기능**:
- `subscribe_price(stock_codes)` - 현재가 구독
- `subscribe_orderbook(stock_codes)` - 호가 구독
- `subscribe_execution(stock_codes)` - 체결 구독
- `unsubscribe_all(stock_code)` - 구독 해제

### 3. 가상매매 timestamp
**파일**: `ai/virtual_trader.py`
**클래스**: `VirtualAccount`
**추가**: `trade_history` 테이블에 timestamp 컬럼

### 4. 동적 손익 관리
**파일**: `main.py`
**함수**: `_check_sell_conditions()`
**개선**: 변동성 기반 동적 임계값 적용

### 5. 점수 계산 개선
**파일**: `strategies/scoring_system.py`
**함수**: `calculate_total_score()`
**개선**: 부분 점수 및 가중치 동적 조정

---

## 🧪 테스트 계획

### Phase 1: Deep Scan 캐싱 (내일 08:00)
- 프리마켓 시간대 3 사이클 테스트
- 모든 사이클에서 점수 정상 계산 확인
- API 호출 횟수 로깅

### Phase 2: 웹소켓 구독 (내일 09:30)
- 삼성전자 현재가 구독 테스트
- 실시간 가격 업데이트 확인
- 손절/익절 타이밍 측정

### Phase 3: 가상매매 개선 (이번 주)
- 동적 손익 관리 백테스트
- 과거 데이터로 시뮬레이션
- 수익률 개선 검증

---

## 📝 참고 사항

### API Rate Limits (추정)
- 체결정보 조회: 초당 10회
- Deep Scan: 분당 60회
- 웹소켓: 무제한 (구독 후)

### 캐싱 전략
- 체결강도: 5분 (변동 적음)
- 프로그램 매수: 5분
- 현재가: 1초 (웹소켓 사용 시 불필요)
- 호가: 3초

### 메모리 사용량
- Deep Scan 캐시: 종목당 ~5KB
- 100종목 x 5KB = 500KB
- 웹소켓 버퍼: ~1MB
- 총 ~2MB 추가 메모리 사용 (무시할 수준)
