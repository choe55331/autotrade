# AutoTrade Pro v4.0 - 고급 기능 가이드

## 개요

AutoTrade Pro v4.0은 30개 이상의 고급 기능을 추가하여 전문적인 자동 매매 시스템으로 진화했습니다.

---

## 🎯 기능적 요소 (Functional Elements)

### 1. 고급 백테스팅 리포트 생성기 (Advanced Backtest Report Generator)
**위치**: `ai/backtest_report_generator.py`

**주요 기능**:
- HTML/PDF 형식의 상세 백테스팅 리포트 생성
- Plotly 기반 인터랙티브 차트 (Equity Curve, Drawdown, Monthly Returns)
- 주요 성과 지표 (Sharpe Ratio, Max Drawdown, Win Rate, Profit Factor)

**사용 예시**:
```python
from ai import BacktestReportGenerator

generator = BacktestReportGenerator()
html_path = generator.generate_html_report(backtest_result)
pdf_path = generator.generate_pdf_report(backtest_result)
```

---

### 2. 전략 파라미터 자동 최적화 (Strategy Parameter Optimizer)
**위치**: `ai/strategy_optimizer.py`

**주요 기능**:
- Grid Search: 모든 파라미터 조합 탐색
- Random Search: 무작위 샘플링
- Bayesian Optimization: Optuna 기반 지능형 탐색

**사용 예시**:
```python
from ai import StrategyOptimizer

optimizer = StrategyOptimizer(
    objective_function=backtest_function,
    param_ranges={
        'ma_period': [5, 10, 20, 30],
        'rsi_threshold': [30, 40, 50, 60, 70]
    },
    method='bayesian',
    n_trials=50
)

result = optimizer.optimize()
print(f"Best params: {result.best_params}")
print(f"Best score: {result.best_score}")
```

---

### 3. ML 기반 이상 감지 시스템 (Anomaly Detection)
**위치**: `ai/anomaly_detector.py`

**주요 기능**:
- Isolation Forest 기반 이상치 탐지
- API 응답 시간, 주문 실패율, 잔고 변동 모니터링
- 실시간 알림 및 로깅

**사용 예시**:
```python
from ai import AnomalyDetector

detector = AnomalyDetector()
anomalies = detector.check_anomalies()

for anomaly in anomalies:
    print(f"[{anomaly.anomaly_type}] {anomaly.description}")
    print(f"Severity: {anomaly.severity}")
```

---

### 4. REST API 프레임워크 (FastAPI)
**위치**: `api_server/main.py`

**주요 기능**:
- 외부에서 설정 조회/변경
- 백테스팅 실행
- 파라미터 최적화 실행
- 시장 레짐 분석
- 이상 감지 조회

**엔드포인트**:
```
GET  /api/settings              # 설정 조회
POST /api/settings              # 설정 저장
POST /api/backtest/run          # 백테스팅 실행
POST /api/optimization/run      # 최적화 실행
GET  /api/market-regime         # 시장 레짐 분석
GET  /api/anomalies             # 이상치 조회
GET  /api/system-connections    # 시스템 연결 상태
```

**실행 방법**:
```bash
cd api_server
uvicorn main:app --reload --port 8000
# http://localhost:8000/docs 에서 Swagger 문서 확인
```

---

### 5. 과거 데이터 리플레이 시뮬레이터 (Replay Simulator)
**위치**: `features/replay_simulator.py`

**주요 기능**:
- 특정 날짜/시간의 시장 데이터 재현
- 호가창, 체결 내역 포함
- 재생 속도 조절 (1x ~ 100x)
- 콜백 기반 이벤트 처리

**사용 예시**:
```python
from features import ReplaySimulator

simulator = ReplaySimulator(playback_speed=10.0)
simulator.load_historical_data("005930", "2024-01-15")

def on_tick(snapshot):
    print(f"[{snapshot.timestamp}] {snapshot.stock_code}: {snapshot.price:,}원")

simulator.register_callback(on_tick)
simulator.play()
```

---

### 6. 포트폴리오 자동 리밸런싱 (Portfolio Rebalancer)
**위치**: `features/portfolio_rebalancer.py`

**주요 기능**:
- 시간 기반 리밸런싱 (일/주/월)
- 임계치 기반 리밸런싱 (편차 5% 이상)
- Risk Parity 전략 지원

**사용 예시**:
```python
from features import PortfolioRebalancer, RebalancingMethod

rebalancer = PortfolioRebalancer(
    method=RebalancingMethod.TIME_BASED,
    frequency='monthly',
    threshold_pct=0.05
)

target_weights = {'005930': 0.3, '000660': 0.3, '035720': 0.4}
current_holdings = rebalancer.get_current_holdings()

if rebalancer.should_rebalance(target_weights, current_holdings):
    orders = rebalancer.calculate_rebalancing_orders(target_weights, current_holdings)
    rebalancer.execute_rebalancing(orders)
```

---

### 7. 통합 설정 관리 시스템 (Unified Settings Manager)
**위치**: `config/unified_settings.py`

**주요 기능**:
- YAML 기반 중앙 집중식 설정 관리
- 실시간 변경 감지 및 콜백
- 7가지 카테고리 (시스템, 리스크, 전략, AI, 백테스팅, API, UI)

**사용 예시**:
```python
from config import get_unified_settings

settings = get_unified_settings()

# 설정 조회
risk_settings = settings.get_category('risk_management')
print(risk_settings['max_position_size'])

# 설정 변경
settings.update_category('risk_management', {
    'max_position_size': 0.25
})

# 변경 감지 콜백
def on_settings_changed(category, old_value, new_value):
    print(f"[{category}] 설정 변경: {old_value} -> {new_value}")

settings.register_callback('risk_management', on_settings_changed)
```

---

## 📊 매매 전략 요소 (Trading Strategies)

### 1. 동적 손절/익절 관리 (Trailing Stop with ATR)
**위치**: `strategy/trailing_stop_manager.py`

**주요 기능**:
- ATR 기반 동적 손절가 조정
- 수익 발생 시 손절선 상향 (Trailing Stop)
- 최소 수익 보호 기능

**사용 예시**:
```python
from strategy import TrailingStopManager

manager = TrailingStopManager({
    'atr_multiplier': 2.0,
    'activation_pct': 0.03,  # 3% 수익 시 활성화
    'min_profit_lock_pct': 0.50  # 최소 수익의 50% 보호
})

# 포지션 추가
manager.add_position("005930", entry_price=70000, atr_value=1000)

# 가격 업데이트
should_sell, reason = manager.update("005930", current_price=72000)
if should_sell:
    print(f"매도 신호: {reason}")
```

---

### 2. 변동성 돌파 전략 (Volatility Breakout)
**위치**: `strategy/volatility_breakout_strategy.py`

**주요 기능**:
- Larry Williams의 변동성 돌파 전략
- 목표가 = 시가 + (전일 고가 - 전일 저가) × K
- 거래량 필터 및 장중 청산

**사용 예시**:
```python
from strategy import VolatilityBreakoutStrategy

strategy = VolatilityBreakoutStrategy(
    k_value=0.5,
    volume_multiplier=1.5
)

# 진입 신호 확인
is_entry, reason = strategy.check_entry_signal(
    stock_code="005930",
    current_time=datetime.now().time(),
    today_open=70000,
    current_price=72000,
    current_volume=1000000
)

# 청산 신호 확인
is_exit, reason = strategy.check_exit_signal(
    stock_code="005930",
    current_time=datetime.now().time()
)
```

---

### 3. 페어 트레이딩 전략 (Pairs Trading)
**위치**: `strategy/pairs_trading_strategy.py`

**주요 기능**:
- 통계적 차익거래 (Statistical Arbitrage)
- Spread 회귀 분석
- Z-Score 기반 진입/청산

**사용 예시**:
```python
from strategy import PairsTradingStrategy

strategy = PairsTradingStrategy(
    entry_threshold=2.0,  # Z-score 2.0 이상 시 진입
    exit_threshold=0.5,   # Z-score 0.5 이하 시 청산
    stop_loss_threshold=3.0
)

# 페어 추가
strategy.add_pair("PAIR_1", "005930", "000660", lookback_days=60)

# 가격 업데이트
strategy.update_prices("PAIR_1", price_a=70000, price_b=140000)

# 진입 신호 확인
is_entry, direction = strategy.check_entry_signal("PAIR_1")
if is_entry:
    print(f"페어 트레이딩 진입: {direction}")
```

---

### 4. 시장 레짐 분류 (Market Regime Classification)
**위치**: `ai/market_regime_classifier.py`

**주요 기능**:
- Bull/Bear/Sideways 시장 분류
- 변동성 수준 탐지 (Low/Medium/High)
- 레짐별 전략 추천

**사용 예시**:
```python
from ai import MarketRegimeClassifier

classifier = MarketRegimeClassifier()

regime, volatility, confidence = classifier.classify(
    price_history=[70000, 71000, 72000, ...],
    volume_history=[1000000, 1200000, ...]
)

print(f"Market Regime: {regime}")  # BULL, BEAR, SIDEWAYS
print(f"Volatility: {volatility}")  # LOW, MEDIUM, HIGH
print(f"Confidence: {confidence:.2f}")

# 추천 전략
strategy_recommendation = classifier.get_strategy_recommendation(regime, volatility)
print(f"Recommended: {strategy_recommendation}")
```

---

### 5. 퀀트 팩터 스크리닝 (Quant Factor Screening)
**위치**: `research/quant_screener.py`

**주요 기능**:
- Magic Formula (Joel Greenblatt)
- Multi-Factor Screening (Value, Quality, Momentum, Low Volatility)
- 종목 랭킹 및 포트폴리오 구성

**사용 예시**:
```python
from research import QuantScreener

screener = QuantScreener()

# 샘플 종목 데이터
stocks = [
    StockFactors(
        stock_code="005930",
        earnings_yield=0.08,
        roc=0.15,
        pb_ratio=1.5,
        pe_ratio=12,
        momentum_12m=0.20,
        volatility=0.25
    ),
    # ... 더 많은 종목
]

# Magic Formula 스크리닝
top_stocks = screener.magic_formula_screen(stocks, top_n=30)

# Multi-Factor 스크리닝
weights = {'value': 0.3, 'quality': 0.3, 'momentum': 0.2, 'low_volatility': 0.2}
top_stocks = screener.multi_factor_screen(stocks, weights, top_n=30)
```

---

### 6. Kelly Criterion 자금 관리 (Kelly Criterion Money Management)
**위치**: `strategy/kelly_criterion.py`

**주요 기능**:
- 최적 포지션 사이징
- Full Kelly / Fractional Kelly
- 리스크 조정 포지션 크기 계산

**사용 예시**:
```python
from strategy import KellyCriterion, KellyParameters

kelly = KellyCriterion(max_position_size=0.30)

params = KellyParameters(
    win_rate=0.55,
    avg_win=5000,
    avg_loss=3000,
    total_capital=10000000,
    kelly_fraction=0.5  # Half Kelly (보수적)
)

optimal_pct = kelly.calculate_kelly_percentage(params)
position_size = kelly.calculate_position_size(params)

print(f"Optimal allocation: {optimal_pct*100:.2f}%")
print(f"Position size: {position_size:,}원")
```

---

### 7. 기관/외국인 추종 전략 (Institutional Following Strategy)
**위치**: `strategy/institutional_following_strategy.py`

**주요 기능**:
- 기관/외국인 순매수 추적
- 연속 매수일 탐지
- 최소 매수 규모 필터

**사용 예시**:
```python
from strategy import InstitutionalFollowingStrategy, InstitutionalData

strategy = InstitutionalFollowingStrategy(
    consecutive_days=3,
    min_net_buy_volume=100000,
    min_net_buy_amount=1000000000
)

# 거래 데이터 추가
strategy.add_trading_data("005930", InstitutionalData(
    date="2024-01-15",
    foreign_net_buy=50000,
    institutional_net_buy=30000
))

# 매수 신호 확인
is_buy, reason = strategy.check_buy_signal("005930")
if is_buy:
    print(f"기관/외국인 추종 매수: {reason}")
```

---

## 🎨 UI/UX 요소 (User Interface)

### 1. 통합 설정 페이지 (Unified Settings Page)
**위치**: `dashboard/templates/settings_unified.html`

**주요 기능**:
- 7개 카테고리 탭 (시스템, 리스크, 전략, AI, 백테스팅, API, UI)
- 실시간 저장/적용/초기화
- 반응형 디자인

**접속**: `http://localhost:5000/settings`

---

### 2. 고급 기능 페이지 (Advanced Features Page)
**위치**: `dashboard/templates/advanced_features.html`

**주요 기능**:
- TradingView Lightweight Charts (인터랙티브 차트)
- 드래그 앤 드롭 전략 빌더
- FullCalendar 매매 일지
- 리플레이 시뮬레이션 컨트롤

**접속**: `http://localhost:5000/advanced-features`

---

### 3. 웹 푸시 알림 (Web Push Notifications)
**위치**: `dashboard/static/service-worker.js`

**주요 기능**:
- Service Worker 기반 PWA
- 백그라운드 알림 수신
- 알림 클릭 액션

---

### 4. 다크 모드 (Dark Mode)
**위치**: `dashboard/templates/settings_unified.html`

**주요 기능**:
- 라이트/다크 테마 전환
- 사용자 설정 저장

---

## 📝 데이터베이스 확장

**위치**: `database/models.py`

### 새로운 테이블:
1. **BacktestResult**: 백테스팅 결과 저장
2. **OptimizationResult**: 파라미터 최적화 결과
3. **Alert**: 알림 이력
4. **StrategyPerformance**: 전략 성과 추적
5. **AnomalyLog**: 이상 감지 로그
6. **MarketRegime**: 시장 레짐 이력

---

## 🚀 시작하기

### 1. 의존성 설치
```bash
pip install -r requirements.txt
```

### 2. 데이터베이스 초기화
```python
from database import init_database
init_database()
```

### 3. 설정 파일 생성
```bash
# config/settings.yaml 자동 생성됨
python -c "from config import get_unified_settings; get_unified_settings()"
```

### 4. 대시보드 실행
```bash
python dashboard/app_apple.py
```

### 5. REST API 서버 실행 (선택)
```bash
cd api_server
uvicorn main:app --reload --port 8000
```

---

## 📚 추가 리소스

- **API 문서**: http://localhost:8000/docs (FastAPI Swagger)
- **대시보드**: http://localhost:5000
- **설정 페이지**: http://localhost:5000/settings
- **고급 기능**: http://localhost:5000/advanced-features

---

## 🔧 문제 해결

### Q: Optuna가 설치되지 않았다는 오류
```bash
pip install optuna
```

### Q: TradingView 차트가 표시되지 않음
- 인터넷 연결 확인 (CDN 사용)
- 브라우저 콘솔에서 에러 확인

### Q: Service Worker 등록 실패
- HTTPS 환경 필요 (로컬은 localhost 예외)
- 브라우저가 Service Worker를 지원하는지 확인

---

## 📄 라이선스

MIT License

---

**AutoTrade Pro v4.0** - Professional Automated Trading System
