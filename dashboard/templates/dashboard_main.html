<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AutoTrade Pro v5.3.1 - AI ìë™ë§¤ë§¤</title>

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">

    <!-- Lightweight Charts -->
    <script src="https://unpkg.com/lightweight-charts@4.1.0/dist/lightweight-charts.standalone.production.js"></script>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

    <!-- Socket.IO -->
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Advanced Chart CSS -->
    <link rel="stylesheet" href="/static/css/advanced-chart.css">

    <style>
        :root {
            --bg-primary: #0a0e27;
            --bg-secondary: #151932;
            --bg-card: #1e2139;
            --border-color: #2d3250;

            --text-primary: #ffffff;
            --text-secondary: #9ca3af;
            --text-muted: #6b7280;

            --color-primary: #3b82f6;
            --color-success: #10b981;
            --color-danger: #ef4444;
            --color-warning: #f59e0b;
            --color-info: #06b6d4;

            --chart-up: #10b981;
            --chart-down: #ef4444;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Noto Sans KR', -apple-system, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            overflow: hidden;
        }

        /* Layout - NO SCROLL */
        .layout {
            display: grid;
            grid-template-columns: 260px 1fr 450px; /* Increased right panel from 320px to 450px */
            grid-template-rows: 60px 1fr;
            height: 100vh;
            width: 100vw;
            gap: 0;
        }

        /* Header */
        .header {
            grid-column: 1 / -1;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            padding: 0 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 18px;
            font-weight: 700;
        }

        .logo i {
            color: var(--color-primary);
        }

        .status-badge {
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .status-badge.live {
            background: rgba(16, 185, 129, 0.1);
            color: var(--color-success);
        }

        .settings-btn {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            justify-content: center;
            text-decoration: none;
            transition: all 0.2s;
        }

        .settings-btn:hover {
            background: var(--color-primary);
            color: white;
            border-color: var(--color-primary);
        }

        /* Sidebar */
        .sidebar {
            background: var(--bg-secondary);
            border-right: 1px solid var(--border-color);
            padding: 15px;
            overflow-y: auto;
        }

        .section-title {
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-muted);
            margin-bottom: 10px;
            margin-top: 15px;
        }

        .section-title:first-child {
            margin-top: 0;
        }

        .account-card {
            background: var(--bg-card);
            border-radius: 10px;
            padding: 12px;
            border: 1px solid var(--border-color);
        }

        .account-value {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .account-label {
            font-size: 11px;
            color: var(--text-secondary);
            margin-bottom: 10px;
        }

        .account-row {
            display: flex;
            justify-content: space-between;
            font-size: 11px;
            margin-bottom: 6px;
        }

        .stat-list {
            list-style: none;
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 10px;
            background: var(--bg-card);
            border-radius: 6px;
            margin-bottom: 6px;
            font-size: 11px;
        }

        .stat-value {
            font-weight: 600;
            color: var(--color-primary);
        }

        /* Connection Status */
        .connection-status {
            font-size: 11px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .connection-status i {
            font-size: 8px;
        }

        .connection-status.connected i {
            color: var(--color-success);
            animation: none;
        }

        .connection-status.disconnected i {
            color: var(--color-danger);
        }

        .connection-status.checking i {
            color: var(--color-warning);
            animation: pulse-dot 1.5s ease-in-out infinite;
        }

        .connection-status.active i {
            color: var(--color-info);
        }

        /* Main Content */
        .main-content {
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 8px;
            background: var(--bg-secondary);
            padding: 10px 15px;
            border-bottom: 1px solid var(--border-color);
        }

        .tab {
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 13px;
            font-weight: 500;
            background: transparent;
            color: var(--text-secondary);
            border: none;
        }

        .tab:hover {
            background: rgba(59, 130, 246, 0.1);
            color: var(--text-primary);
        }

        .tab.active {
            background: var(--color-primary);
            color: white;
        }

        /* Tab Content */
        .tab-content {
            flex: 1;
            padding: 12px;
            overflow-y: auto;
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Cards */
        .card {
            background: var(--bg-card);
            border-radius: 10px;
            padding: 12px;
            border: 1px solid var(--border-color);
            margin-bottom: 10px;
        }

        .card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 10px;
        }

        .card-title {
            font-size: 14px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .card-title i {
            color: var(--color-primary);
        }

        /* Chart Container */
        #main-chart {
            height: 350px; /* Reduced from 400px to 350px for better space distribution */
            margin-bottom: 10px;
        }

        /* Grid */
        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 10px;
        }

        .grid-3 {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 10px;
            margin-bottom: 10px;
        }

        /* AI Analysis Cards */
        .ai-result-card {
            background: var(--bg-card);
            border-radius: 8px;
            padding: 10px;
            border: 1px solid var(--border-color);
        }

        .ai-result-title {
            font-size: 12px;
            font-weight: 600;
            margin-bottom: 6px;
            color: var(--text-secondary);
        }

        .ai-result-value {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .ai-result-desc {
            font-size: 11px;
            color: var(--text-secondary);
        }

        /* Right Panel */
        .right-panel {
            background: var(--bg-secondary);
            border-left: 1px solid var(--border-color);
            padding: 15px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .right-panel-section {
            flex: 1;
            min-height: 0;
            display: flex;
            flex-direction: column;
        }

        .section-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 10px;
            padding-bottom: 8px;
            border-bottom: 2px solid var(--border-color);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .section-title i {
            color: var(--color-primary);
        }

        .compact-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 10px;
            overflow-y: auto;
            flex: 1;
            min-height: 0;
        }

        .compact-card .loading {
            text-align: center;
            color: var(--text-secondary);
            padding: 20px;
            font-size: 12px;
        }

        .candidate-item {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .candidate-item:hover {
            border-color: var(--color-primary);
            transform: translateY(-2px);
        }

        .candidate-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
        }

        .candidate-name {
            font-weight: 600;
            font-size: 13px;
        }

        .candidate-score {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
        }

        .candidate-info {
            font-size: 11px;
            color: var(--text-secondary);
            margin-bottom: 6px;
        }

        .candidate-signals {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
        }

        .signal-badge {
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 600;
        }

        .signal-badge.buy {
            background: rgba(16, 185, 129, 0.1);
            color: var(--color-success);
        }

        /* Trading Activity */
        .activity-item {
            padding: 8px;
            border-left: 3px solid var(--color-primary);
            background: rgba(59, 130, 246, 0.05);
            border-radius: 4px;
            margin-bottom: 8px;
        }

        .activity-time {
            font-size: 10px;
            color: var(--text-muted);
            margin-bottom: 4px;
        }

        .activity-text {
            font-size: 12px;
        }

        .activity-item.buy {
            border-left-color: var(--color-success);
            background: rgba(16, 185, 129, 0.05);
        }

        .activity-item.sell {
            border-left-color: var(--color-danger);
            background: rgba(239, 68, 68, 0.05);
        }

        /* Performance Metrics */
        .metric-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid var(--border-color);
            font-size: 12px;
        }

        .metric-row:last-child {
            border-bottom: none;
        }

        .metric-label {
            color: var(--text-secondary);
        }

        .metric-value {
            font-weight: 600;
        }

        .metric-value.positive {
            color: var(--color-success);
        }

        .metric-value.negative {
            color: var(--color-danger);
        }

        /* Toast */
        .toast {
            position: fixed;
            top: 80px;
            right: 20px;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 12px 16px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            z-index: 10000;
            animation: slideIn 0.3s;
            font-size: 13px;
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 20px;
            color: var(--text-secondary);
        }

        .spinner {
            border: 3px solid var(--border-color);
            border-top: 3px solid var(--color-primary);
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Real-time indicator */
        .realtime-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--color-success);
            animation: pulse-dot 2s infinite;
            display: inline-block;
            margin-right: 4px;
        }

        @keyframes pulse-dot {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
    </style>
</head>
<body>
    <div class="layout">
        <!-- Header -->
        <header class="header">
            <div class="logo">
                <i class="fas fa-chart-line"></i>
                <span>AutoTrade Pro v5.3.1 AI</span>
            </div>
            <div style="display: flex; align-items: center; gap: 15px;">
                <a href="/settings" target="_blank" class="settings-btn" title="ì„¤ì •">
                    <i class="fas fa-cog"></i>
                </a>
                <div class="status-badge live" id="status-indicator">
                    <span class="realtime-indicator"></span>
                    <span id="status-text">AI ìë™ë§¤ë§¤ ì‹¤í–‰ ì¤‘</span>
                </div>
            </div>
        </header>

        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="section-title">ê³„ì¢Œ ì •ë³´</div>
            <div class="account-card">
                <div class="account-value" id="total-assets">â‚©0</div>
                <div class="account-label">ì´ ìì‚°</div>

                <div class="account-row">
                    <span>ë³´ìœ  í˜„ê¸ˆ</span>
                    <span id="cash">â‚©0</span>
                </div>
                <div class="account-row">
                    <span>ì£¼ì‹ í‰ê°€ì•¡</span>
                    <span id="stock-value">â‚©0</span>
                </div>
                <div class="account-row">
                    <span>ì†ìµ</span>
                    <span id="profit-loss" style="color: var(--color-success);">+â‚©0</span>
                </div>
            </div>

            <div class="section-title">
                <i class="fas fa-broadcast-tower"></i> WebSocket ì‹¤ì‹œê°„ êµ¬ë…
            </div>
            <div style="margin-bottom: 20px; padding: 12px; background: rgba(59, 130, 246, 0.1); border-radius: 8px; border: 1px solid rgba(59, 130, 246, 0.3);">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <span style="font-size: 12px; font-weight: 600;">ì´ êµ¬ë…</span>
                    <span id="ws-total-badge" style="padding: 2px 8px; background: var(--color-primary); border-radius: 12px; font-size: 11px; font-weight: 700;">0</span>
                </div>
                <div style="font-size: 11px; color: var(--text-secondary); margin-bottom: 8px;">
                    <strong style="color: var(--color-primary);">ğŸ“Š í˜„ì¬ê°€ (KA10003)</strong>
                    <div id="ws-price-list" style="margin-top: 4px; font-size: 10px;">ì—†ìŒ</div>
                </div>
                <div style="font-size: 11px; color: var(--text-secondary); margin-bottom: 8px;">
                    <strong style="color: var(--color-success);">ğŸ“ˆ í˜¸ê°€ (KA10004)</strong>
                    <div id="ws-orderbook-list" style="margin-top: 4px; font-size: 10px;">ì—†ìŒ</div>
                </div>
                <div style="font-size: 11px; color: var(--text-secondary);">
                    <strong style="color: var(--color-warning);">âš¡ ì²´ê²° (KA10005)</strong>
                    <div id="ws-execution-list" style="margin-top: 4px; font-size: 10px;">ì—†ìŒ</div>
                </div>
            </div>

            <div class="section-title">ì‹œìŠ¤í…œ ì—°ê²° ìƒíƒœ</div>
            <ul class="stat-list">
                <li class="stat-item">
                    <span class="stat-label">REST API</span>
                    <span class="connection-status" id="conn-rest-api">
                        <i class="fas fa-circle"></i> <span>í™•ì¸ì¤‘</span>
                    </span>
                </li>
                <li class="stat-item">
                    <span class="stat-label">WebSocket</span>
                    <span class="connection-status" id="conn-websocket">
                        <i class="fas fa-circle"></i> <span>í™•ì¸ì¤‘</span>
                    </span>
                </li>
                <li class="stat-item">
                    <span class="stat-label">Gemini AI</span>
                    <span class="connection-status" id="conn-gemini">
                        <i class="fas fa-circle"></i> <span>í™•ì¸ì¤‘</span>
                    </span>
                </li>
                <li class="stat-item">
                    <span class="stat-label">í…ŒìŠ¤íŠ¸ ëª¨ë“œ</span>
                    <span class="connection-status" id="conn-testmode">
                        <i class="fas fa-circle"></i> <span>í™•ì¸ì¤‘</span>
                    </span>
                </li>
            </ul>
        </aside>

        <!-- Main Content with Tabs -->
        <main class="main-content">
            <div class="tabs">
                <button class="tab active" onclick="switchTab(0)">
                    <i class="fas fa-home"></i> ë©”ì¸
                </button>
                <button class="tab" onclick="switchTab(1)">
                    <i class="fas fa-robot"></i> AI ë¶„ì„
                </button>
                <button class="tab" onclick="switchTab(2)">
                    <i class="fas fa-coins"></i> ê°€ìƒë§¤ë§¤ ì„±ê³¼
                </button>
                <button class="tab" onclick="switchTab(3)">
                    <i class="fas fa-search-dollar"></i> ì‹œì¥ íƒìƒ‰
                </button>
                <button class="tab" onclick="switchTab(4)">
                    <i class="fas fa-chart-pie"></i> í¬íŠ¸í´ë¦¬ì˜¤
                </button>
                <button class="tab" onclick="switchTab(5)">
                    <i class="fas fa-newspaper"></i> ê°ì„± ë¶„ì„
                </button>
                <button class="tab" onclick="switchTab(6)">
                    <i class="fas fa-shield-alt"></i> ë¦¬ìŠ¤í¬ ê´€ë¦¬
                </button>
                <button class="tab" onclick="switchTab(7)">
                    <i class="fas fa-brain"></i> ë§ˆì¼“ ë ˆì§
                </button>
            </div>

            <!-- Tab 1: Main Dashboard -->
            <div class="tab-content active" id="tab-main">
                <!-- Real-time Chart with Search -->
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">
                            <i class="fas fa-chart-candlestick"></i>
                            <span id="chart-stock-name">ì‹¤ì‹œê°„ ì°¨íŠ¸</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <!-- Stock Search -->
                            <div style="position: relative;">
                                <input
                                    type="text"
                                    id="stock-search-input"
                                    placeholder="ì¢…ëª© ê²€ìƒ‰..."
                                    style="padding: 6px 12px; border-radius: 6px; border: 1px solid var(--border-color); background: var(--bg-primary); color: var(--text-primary); font-size: 12px; width: 200px;"
                                    autocomplete="off"
                                />
                                <!-- Search Results Dropdown -->
                                <div id="stock-search-results" style="display: none; position: absolute; top: 100%; right: 0; margin-top: 4px; background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 6px; width: 300px; max-height: 300px; overflow-y: auto; z-index: 1000; box-shadow: 0 4px 6px rgba(0,0,0,0.3);"></div>
                            </div>
                            <span style="font-size: 12px; color: var(--text-secondary);" id="chart-price">â‚©0</span>
                        </div>
                    </div>
                    <div id="main-chart"></div>
                </div>
            </div>

            <!-- Tab 2: AI Analysis -->
            <div class="tab-content" id="tab-ai">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">
                            <i class="fas fa-brain"></i>
                            AI ìë™ ë¶„ì„ ê²°ê³¼ (ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸)
                        </div>
                        <span style="font-size: 11px; color: var(--text-secondary);">
                            <span class="realtime-indicator"></span>ë§¤ 30ì´ˆ ê°±ì‹ 
                        </span>
                    </div>
                    <div class="grid-3">
                        <div class="ai-result-card">
                            <div class="ai-result-title">í¬íŠ¸í´ë¦¬ì˜¤ ì ìˆ˜</div>
                            <div class="ai-result-value" id="ai-portfolio-score">-</div>
                            <div class="ai-result-desc" id="ai-portfolio-desc">ë¶„ì„ ëŒ€ê¸° ì¤‘</div>
                        </div>
                        <div class="ai-result-card">
                            <div class="ai-result-title">ì‹œì¥ ê°ì •</div>
                            <div class="ai-result-value" id="ai-sentiment">-</div>
                            <div class="ai-result-desc" id="ai-sentiment-desc">ë¶„ì„ ëŒ€ê¸° ì¤‘</div>
                        </div>
                        <div class="ai-result-card">
                            <div class="ai-result-title">ë¦¬ìŠ¤í¬ ë ˆë²¨</div>
                            <div class="ai-result-value" id="ai-risk">-</div>
                            <div class="ai-result-desc" id="ai-risk-desc">ë¶„ì„ ëŒ€ê¸° ì¤‘</div>
                        </div>
                    </div>
                </div>

                <div class="grid-2">
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">
                                <i class="fas fa-chart-pie"></i>
                                í¬íŠ¸í´ë¦¬ì˜¤ ìµœì í™”
                            </div>
                        </div>
                        <div id="portfolio-analysis">
                            <div class="loading">
                                <div class="spinner"></div>
                                <p>ë¶„ì„ ì¤‘...</p>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">
                                <i class="fas fa-shield-alt"></i>
                                ë¦¬ìŠ¤í¬ ë¶„ì„
                            </div>
                        </div>
                        <div id="risk-analysis">
                            <div class="loading">
                                <div class="spinner"></div>
                                <p>ë¶„ì„ ì¤‘...</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <div class="card-title">
                            <i class="fas fa-users"></i>
                            ë‹¤ì¤‘ AI ì—ì´ì „íŠ¸ í•©ì˜
                        </div>
                    </div>
                    <div id="multiagent-consensus">
                        <div class="loading">
                            <div class="spinner"></div>
                            <p>í•©ì˜ ì¤‘...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tab 3: Virtual Trading (Paper Trading) -->
            <div class="tab-content" id="tab-backtest">
                <!-- Best Strategy Banner -->
                <div id="best-strategy-banner" style="display: none; background: linear-gradient(135deg, #10b981 0%, #059669 100%); padding: 20px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);">
                    <div style="display: flex; align-items: center; gap: 15px;">
                        <i class="fas fa-trophy" style="font-size: 36px; color: #fbbf24;"></i>
                        <div>
                            <div style="font-size: 14px; opacity: 0.9; margin-bottom: 4px;">ìµœê³  ì„±ê³¼ ì „ëµ</div>
                            <div style="font-size: 24px; font-weight: 700;" id="best-strategy-name">-</div>
                            <div style="font-size: 16px; margin-top: 4px;"><span id="best-strategy-return">+0.00%</span> ìˆ˜ìµë¥ </div>
                        </div>
                    </div>
                </div>

                <!-- Strategy Cards Grid -->
                <div class="grid-3" id="virtual-strategies-grid">
                    <!-- ê³µê²©ì  ì „ëµ -->
                    <div class="card" id="strategy-aggressive" style="cursor: pointer;" onclick="toggleStrategyDetails('ê³µê²©ì ')">
                        <div class="card-header">
                            <div class="card-title">
                                <i class="fas fa-fire" style="color: #ef4444;"></i> ê³µê²©ì  ì „ëµ
                            </div>
                        </div>
                        <div style="padding: 15px;">
                            <div class="metric-row">
                                <span class="metric-label">ìì‚°</span>
                                <span class="metric-value" id="aggressive-cash">-</span>
                            </div>
                            <div class="metric-row">
                                <span class="metric-label">ìˆ˜ìµë¥ </span>
                                <span class="metric-value" id="aggressive-return">-</span>
                            </div>
                            <div class="metric-row">
                                <span class="metric-label">í¬ì§€ì…˜</span>
                                <span class="metric-value" id="aggressive-positions">-</span>
                            </div>
                            <div class="metric-row">
                                <span class="metric-label">ìŠ¹ë¥ </span>
                                <span class="metric-value" id="aggressive-winrate">-</span>
                            </div>
                        </div>
                        <!-- Position Details (Hidden by default) -->
                        <div id="aggressive-details" style="display: none; border-top: 1px solid var(--border); padding: 15px; background: var(--bg-dark);">
                            <div style="font-size: 12px; font-weight: 600; margin-bottom: 10px; color: var(--text-secondary);">ë³´ìœ  í¬ì§€ì…˜</div>
                            <div id="aggressive-positions-list"></div>
                        </div>
                    </div>

                    <!-- ë³´ìˆ˜ì  ì „ëµ -->
                    <div class="card" id="strategy-conservative" style="cursor: pointer;" onclick="toggleStrategyDetails('ë³´ìˆ˜ì ')">
                        <div class="card-header">
                            <div class="card-title">
                                <i class="fas fa-shield-alt" style="color: #3b82f6;"></i> ë³´ìˆ˜ì  ì „ëµ
                            </div>
                        </div>
                        <div style="padding: 15px;">
                            <div class="metric-row">
                                <span class="metric-label">ìì‚°</span>
                                <span class="metric-value" id="conservative-cash">-</span>
                            </div>
                            <div class="metric-row">
                                <span class="metric-label">ìˆ˜ìµë¥ </span>
                                <span class="metric-value" id="conservative-return">-</span>
                            </div>
                            <div class="metric-row">
                                <span class="metric-label">í¬ì§€ì…˜</span>
                                <span class="metric-value" id="conservative-positions">-</span>
                            </div>
                            <div class="metric-row">
                                <span class="metric-label">ìŠ¹ë¥ </span>
                                <span class="metric-value" id="conservative-winrate">-</span>
                            </div>
                        </div>
                        <!-- Position Details (Hidden by default) -->
                        <div id="conservative-details" style="display: none; border-top: 1px solid var(--border); padding: 15px; background: var(--bg-dark);">
                            <div style="font-size: 12px; font-weight: 600; margin-bottom: 10px; color: var(--text-secondary);">ë³´ìœ  í¬ì§€ì…˜</div>
                            <div id="conservative-positions-list"></div>
                        </div>
                    </div>

                    <!-- ê· í˜• ì „ëµ -->
                    <div class="card" id="strategy-balanced" style="cursor: pointer;" onclick="toggleStrategyDetails('ê· í˜•')">
                        <div class="card-header">
                            <div class="card-title">
                                <i class="fas fa-balance-scale" style="color: #f59e0b;"></i> ê· í˜• ì „ëµ
                            </div>
                        </div>
                        <div style="padding: 15px;">
                            <div class="metric-row">
                                <span class="metric-label">ìì‚°</span>
                                <span class="metric-value" id="balanced-cash">-</span>
                            </div>
                            <div class="metric-row">
                                <span class="metric-label">ìˆ˜ìµë¥ </span>
                                <span class="metric-value" id="balanced-return">-</span>
                            </div>
                            <div class="metric-row">
                                <span class="metric-label">í¬ì§€ì…˜</span>
                                <span class="metric-value" id="balanced-positions">-</span>
                            </div>
                            <div class="metric-row">
                                <span class="metric-label">ìŠ¹ë¥ </span>
                                <span class="metric-value" id="balanced-winrate">-</span>
                            </div>
                        </div>
                        <!-- Position Details (Hidden by default) -->
                        <div id="balanced-details" style="display: none; border-top: 1px solid var(--border); padding: 15px; background: var(--bg-dark);">
                            <div style="font-size: 12px; font-weight: 600; margin-bottom: 10px; color: var(--text-secondary);">ë³´ìœ  í¬ì§€ì…˜</div>
                            <div id="balanced-positions-list"></div>
                        </div>
                    </div>
                </div>

                <!-- Recent Trades -->
                <div class="card" style="margin-top: 20px;">
                    <div class="card-header">
                        <div class="card-title">
                            <i class="fas fa-history"></i> ìµœê·¼ ë§¤ë§¤ ê¸°ë¡ (ì „ì²´ ì „ëµ)
                        </div>
                    </div>
                    <div id="virtual-trades-list" style="max-height: 300px; overflow-y: auto; padding: 15px;">
                        <div class="loading">
                            <div class="spinner"></div>
                            <p style="margin-top: 10px;">ë°ì´í„° ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tab 4: Market Exploration -->
            <div class="tab-content" id="tab-market-explorer">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">
                            <i class="fas fa-search-dollar"></i>
                            ì‹œì¥ íƒìƒ‰
                        </div>
                    </div>

                    <!-- Filter Controls -->
                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; padding: 15px; background: var(--card-bg); border-radius: 8px; margin-bottom: 15px;">
                        <div>
                            <label style="font-size: 11px; color: var(--text-secondary); margin-bottom: 5px; display: block;">íƒìƒ‰ ê¸°ì¤€</label>
                            <select id="market-filter-type" style="width: 100%; padding: 8px; border-radius: 6px; border: 1px solid var(--border-color); background: var(--bg-primary); color: var(--text-primary); font-size: 12px;">
                                <option value="volume">ê±°ë˜ëŸ‰</option>
                                <option value="trading-value">ê±°ë˜ëŒ€ê¸ˆ</option>
                                <option value="price-change">ìƒìŠ¹ë¥ </option>
                            </select>
                        </div>
                        <div>
                            <label style="font-size: 11px; color: var(--text-secondary); margin-bottom: 5px; display: block;">ì‹œì¥</label>
                            <select id="market-filter-market" style="width: 100%; padding: 8px; border-radius: 6px; border: 1px solid var(--border-color); background: var(--bg-primary); color: var(--text-primary); font-size: 12px;">
                                <option value="ALL">ì „ì²´</option>
                                <option value="KOSPI">ì½”ìŠ¤í”¼</option>
                                <option value="KOSDAQ">ì½”ìŠ¤ë‹¥</option>
                            </select>
                        </div>
                        <div id="sort-option-container" style="display: none;">
                            <label style="font-size: 11px; color: var(--text-secondary); margin-bottom: 5px; display: block;">ì •ë ¬</label>
                            <select id="market-filter-sort" style="width: 100%; padding: 8px; border-radius: 6px; border: 1px solid var(--border-color); background: var(--bg-primary); color: var(--text-primary); font-size: 12px;">
                                <option value="rise">ìƒìŠ¹ë¥  ìˆœ</option>
                                <option value="fall">í•˜ë½ë¥  ìˆœ</option>
                            </select>
                        </div>
                        <div>
                            <label style="font-size: 11px; color: var(--text-secondary); margin-bottom: 5px; display: block;">ì¡°íšŒ ê°œìˆ˜</label>
                            <select id="market-filter-limit" style="width: 100%; padding: 8px; border-radius: 6px; border: 1px solid var(--border-color); background: var(--bg-primary); color: var(--text-primary); font-size: 12px;">
                                <option value="20">20ê°œ</option>
                                <option value="50">50ê°œ</option>
                                <option value="100">100ê°œ</option>
                            </select>
                        </div>
                    </div>

                    <div style="padding: 0 15px 15px 15px;">
                        <button onclick="loadMarketData()" style="width: 100%; padding: 10px; border-radius: 6px; border: none; background: var(--primary-color); color: white; font-size: 13px; font-weight: 600; cursor: pointer; transition: opacity 0.2s;">
                            <i class="fas fa-search"></i> íƒìƒ‰í•˜ê¸°
                        </button>
                    </div>
                </div>

                <!-- Results Table -->
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">
                            <i class="fas fa-table"></i>
                            <span id="market-results-title">íƒìƒ‰ ê²°ê³¼</span>
                        </div>
                        <span id="market-results-count" style="font-size: 11px; color: var(--text-secondary);"></span>
                    </div>
                    <div id="market-results" style="overflow-x: auto;">
                        <div class="loading" style="padding: 40px; text-align: center;">
                            <p style="font-size: 12px; color: var(--text-secondary);">í•„í„°ë¥¼ ì„ íƒí•˜ê³  íƒìƒ‰í•˜ê¸°ë¥¼ í´ë¦­í•˜ì„¸ìš”</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tab 5: Real Portfolio with ATR-based Stops (v5.1) -->
            <div class="tab-content" id="tab-portfolio">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">
                            <i class="fas fa-chart-pie"></i>
                            ì‹¤ì œ ë³´ìœ  ì¢…ëª© (ATR ê¸°ë°˜ ì†ìµ ê´€ë¦¬)
                        </div>
                        <span style="font-size: 11px; color: var(--text-secondary);">
                            <span class="realtime-indicator"></span>ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸
                        </span>
                    </div>
                    <div style="overflow-x: auto;">
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead style="background: var(--bg-secondary);">
                                <tr>
                                    <th style="padding: 12px; text-align: left; font-size: 12px; color: var(--text-secondary);">ì¢…ëª©</th>
                                    <th style="padding: 12px; text-align: right; font-size: 12px; color: var(--text-secondary);">ìˆ˜ëŸ‰</th>
                                    <th style="padding: 12px; text-align: right; font-size: 12px; color: var(--text-secondary);">í‰ê· ê°€</th>
                                    <th style="padding: 12px; text-align: right; font-size: 12px; color: var(--text-secondary);">í˜„ì¬ê°€</th>
                                    <th style="padding: 12px; text-align: right; font-size: 12px; color: var(--text-secondary);">ì†ì ˆê°€ (ATR)</th>
                                    <th style="padding: 12px; text-align: right; font-size: 12px; color: var(--text-secondary);">ìµì ˆê°€ (ATR)</th>
                                    <th style="padding: 12px; text-align: right; font-size: 12px; color: var(--text-secondary);">ìˆ˜ìµë¥ </th>
                                    <th style="padding: 12px; text-align: right; font-size: 12px; color: var(--text-secondary);">í‰ê°€ì•¡</th>
                                    <th style="padding: 12px; text-align: right; font-size: 12px; color: var(--text-secondary);">Kelly / Sharpe</th>
                                    <th style="padding: 12px; text-align: right; font-size: 12px; color: var(--text-secondary);">RSI / R:R</th>
                                </tr>
                            </thead>
                            <tbody id="real-holdings-table">
                                <tr>
                                    <td colspan="8" style="text-align: center; padding: 40px; color: var(--text-secondary);">
                                        <div class="loading">
                                            <div class="spinner"></div>
                                            <p style="margin-top: 10px;">ë°ì´í„° ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- ì§„ë³´ëœ ì§€í‘œ ì„¤ëª… ì¹´ë“œ -->
                <div class="card" style="margin-top: 20px;">
                    <div class="card-header">
                        <div class="card-title">
                            <i class="fas fa-info-circle"></i>
                            ì§„ë³´ëœ í¬íŠ¸í´ë¦¬ì˜¤ ë¶„ì„ ì§€í‘œ ì„¤ëª…
                        </div>
                    </div>
                    <div style="padding: 15px; font-size: 12px; line-height: 1.6;">
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
                            <div>
                                <strong style="color: var(--color-primary);">ATR (Average True Range)</strong>
                                <ul style="margin: 5px 0 0 15px; color: var(--text-secondary);">
                                    <li>ì†ì ˆê°€ = í‰ê· ê°€ - (ATR Ã— 2)</li>
                                    <li>ìµì ˆê°€ = í‰ê· ê°€ + (ATR Ã— 3)</li>
                                    <li>ë³€ë™ì„± ê¸°ë°˜ ë™ì  ì†ìµ ê´€ë¦¬</li>
                                </ul>
                            </div>
                            <div>
                                <strong style="color: var(--color-success);">Kelly Criterion (K)</strong>
                                <ul style="margin: 5px 0 0 15px; color: var(--text-secondary);">
                                    <li>ìµœì  í¬ì§€ì…˜ í¬ê¸° ê³„ì‚°</li>
                                    <li>15% ì´ìƒ: ê³µê²©ì  ë¹„ì¤‘ ê°€ëŠ¥</li>
                                    <li>5% ì´í•˜: ë³´ìˆ˜ì  ì ‘ê·¼ ê¶Œì¥</li>
                                </ul>
                            </div>
                            <div>
                                <strong style="color: var(--color-warning);">Sharpe Ratio (S)</strong>
                                <ul style="margin: 5px 0 0 15px; color: var(--text-secondary);">
                                    <li>ìœ„í—˜ ì¡°ì • ìˆ˜ìµë¥  (20ì¼ ê¸°ì¤€)</li>
                                    <li>1.0 ì´ìƒ: ìš°ìˆ˜í•œ risk-return</li>
                                    <li>ìŒìˆ˜: ì†ì‹¤ ìœ„í—˜ ë†’ìŒ</li>
                                </ul>
                            </div>
                            <div>
                                <strong style="color: var(--color-danger);">Maximum Drawdown (MDD)</strong>
                                <ul style="margin: 5px 0 0 15px; color: var(--text-secondary);">
                                    <li>ìµœê³ ì  ëŒ€ë¹„ ìµœëŒ€ ë‚™í­</li>
                                    <li>20% ì´ìƒ: ê³ ìœ„í—˜ êµ¬ê°„</li>
                                    <li>ì†ì‹¤ ë‚´ì„± ìˆ˜ì¤€ íŒŒì•…</li>
                                </ul>
                            </div>
                            <div>
                                <strong style="color: var(--color-primary);">RSI (Relative Strength Index)</strong>
                                <ul style="margin: 5px 0 0 15px; color: var(--text-secondary);">
                                    <li>70 ì´ìƒ: ê³¼ë§¤ìˆ˜ (ë§¤ë„ ì‹ í˜¸)</li>
                                    <li>30 ì´í•˜: ê³¼ë§¤ë„ (ë§¤ìˆ˜ ì‹ í˜¸)</li>
                                    <li>ëª¨ë©˜í…€ ê°•ë„ ì¸¡ì •</li>
                                </ul>
                            </div>
                            <div>
                                <strong style="color: var(--color-success);">Risk/Reward Ratio (R:R)</strong>
                                <ul style="margin: 5px 0 0 15px; color: var(--text-secondary);">
                                    <li>ìµì ˆí­ / ì†ì ˆí­ ë¹„ìœ¨</li>
                                    <li>2:1 ì´ìƒ: ì–‘í˜¸í•œ ê±°ë˜</li>
                                    <li>1:1 ì´í•˜: ìœ„í—˜ ë†’ì€ ê±°ë˜</li>
                                </ul>
                            </div>
                            <div style="grid-column: 1 / -1;">
                                <strong style="color: var(--color-info);">Bollinger Bands Position (BB)</strong>
                                <ul style="margin: 5px 0 0 15px; color: var(--text-secondary);">
                                    <li>100%: ìƒë‹¨ ë°´ë“œ (ê³¼ë§¤ìˆ˜ ê°€ëŠ¥)</li>
                                    <li>50%: ì¤‘ì•™ì„  (ì •ìƒ)</li>
                                    <li>0%: í•˜ë‹¨ ë°´ë“œ (ê³¼ë§¤ë„ ê°€ëŠ¥)</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tab 6: Sentiment Analysis (v4.2) -->
            <div class="tab-content" id="tab-sentiment">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">
                            <i class="fas fa-newspaper"></i>
                            ê°ì„± ë¶„ì„ (v4.2)
                        </div>
                    </div>
                    <div style="padding: 20px;">
                        <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 15px; margin-bottom: 20px;">
                            <input type="text" id="sentiment-stock-code" placeholder="ì¢…ëª© ì½”ë“œ ì…ë ¥ (ì˜ˆ: 005930)" style="padding: 12px; border-radius: 6px; border: 1px solid var(--border-color); background: var(--bg-primary); color: var(--text-primary);">
                            <button onclick="analyzeSentiment()" style="padding: 12px; border-radius: 6px; border: none; background: var(--color-primary); color: white; font-weight: 600; cursor: pointer;">
                                <i class="fas fa-search"></i> ë¶„ì„
                            </button>
                        </div>
                        <div id="sentiment-results" style="display: none;">
                            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 20px;">
                                <div style="padding: 20px; background: var(--bg-secondary); border-radius: 8px; text-align: center;">
                                    <div style="font-size: 11px; color: var(--text-secondary); margin-bottom: 8px;">ì „ì²´ ê°ì„±</div>
                                    <div style="font-size: 32px; font-weight: 700;" id="sentiment-overall">-</div>
                                    <div style="font-size: 12px; color: var(--text-secondary); margin-top: 5px;" id="sentiment-label">-</div>
                                </div>
                                <div style="padding: 20px; background: var(--bg-secondary); border-radius: 8px; text-align: center;">
                                    <div style="font-size: 11px; color: var(--text-secondary); margin-bottom: 8px;">ë‰´ìŠ¤ ê°ì„±</div>
                                    <div style="font-size: 32px; font-weight: 700; color: var(--color-info);" id="sentiment-news">-</div>
                                </div>
                                <div style="padding: 20px; background: var(--bg-secondary); border-radius: 8px; text-align: center;">
                                    <div style="font-size: 11px; color: var(--text-secondary); margin-bottom: 8px;">ì†Œì…œ ê°ì„±</div>
                                    <div style="font-size: 32px; font-weight: 700; color: var(--color-warning);" id="sentiment-social">-</div>
                                </div>
                            </div>
                            <div style="padding: 15px; background: var(--bg-secondary); border-radius: 8px;">
                                <h4 style="font-size: 13px; margin-bottom: 10px;">ìµœê·¼ ë‰´ìŠ¤</h4>
                                <div id="sentiment-news-list" style="font-size: 12px; color: var(--text-secondary);"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tab 7: Risk Management (v4.2) -->
            <div class="tab-content" id="tab-risk">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">
                            <i class="fas fa-shield-alt"></i>
                            ê³ ê¸‰ ë¦¬ìŠ¤í¬ ê´€ë¦¬ (v4.2)
                        </div>
                    </div>
                    <div style="padding: 20px;">
                        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 20px;">
                            <div style="padding: 20px; background: var(--bg-secondary); border-radius: 8px; text-align: center;">
                                <div style="font-size: 11px; color: var(--text-secondary); margin-bottom: 8px;">VaR (95%)</div>
                                <div style="font-size: 24px; font-weight: 700; color: var(--color-danger);" id="risk-var">-</div>
                            </div>
                            <div style="padding: 20px; background: var(--bg-secondary); border-radius: 8px; text-align: center;">
                                <div style="font-size: 11px; color: var(--text-secondary); margin-bottom: 8px;">CVaR (95%)</div>
                                <div style="font-size: 24px; font-weight: 700; color: var(--color-danger);" id="risk-cvar">-</div>
                            </div>
                            <div style="padding: 20px; background: var(--bg-secondary); border-radius: 8px; text-align: center;">
                                <div style="font-size: 11px; color: var(--text-secondary); margin-bottom: 8px;">ìµœëŒ€ ì†ì‹¤</div>
                                <div style="font-size: 24px; font-weight: 700; color: var(--color-warning);" id="risk-max-loss">-</div>
                            </div>
                            <div style="padding: 20px; background: var(--bg-secondary); border-radius: 8px; text-align: center;">
                                <div style="font-size: 11px; color: var(--text-secondary); margin-bottom: 8px;">ë¦¬ìŠ¤í¬ ë ˆë²¨</div>
                                <div style="font-size: 24px; font-weight: 700;" id="risk-level">-</div>
                            </div>
                        </div>
                        <button onclick="assessRisk()" style="width: 100%; padding: 12px; border-radius: 6px; border: none; background: var(--color-primary); color: white; font-weight: 600; cursor: pointer;">
                            <i class="fas fa-calculator"></i> ë¦¬ìŠ¤í¬ í‰ê°€ ì‹¤í–‰
                        </button>
                        <div id="risk-chart" style="margin-top: 20px; height: 300px; background: var(--bg-secondary); border-radius: 8px;"></div>
                    </div>
                </div>
            </div>

            <!-- Tab 8: Market Regime (v4.2) -->
            <div class="tab-content" id="tab-regime">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">
                            <i class="fas fa-brain"></i>
                            ë§ˆì¼“ ë ˆì§ ê°ì§€ (v4.2)
                        </div>
                    </div>
                    <div style="padding: 20px;">
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-bottom: 20px;">
                            <div style="padding: 30px; background: var(--bg-secondary); border-radius: 12px; text-align: center;">
                                <div style="font-size: 13px; color: var(--text-secondary); margin-bottom: 15px;">í˜„ì¬ ì‹œì¥ ìƒíƒœ</div>
                                <div style="font-size: 36px; font-weight: 700; margin-bottom: 10px;" id="regime-current">-</div>
                                <div style="font-size: 12px; color: var(--text-secondary);" id="regime-confidence">ì‹ ë¢°ë„: -</div>
                            </div>
                            <div style="padding: 20px; background: var(--bg-secondary); border-radius: 12px;">
                                <div style="font-size: 13px; color: var(--text-secondary); margin-bottom: 15px;">ì‹œì¥ ì§€í‘œ</div>
                                <div style="display: grid; gap: 10px;">
                                    <div style="display: flex; justify-content: space-between;">
                                        <span style="font-size: 12px;">ë³€ë™ì„±:</span>
                                        <span style="font-size: 12px; font-weight: 700;" id="regime-volatility">-</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between;">
                                        <span style="font-size: 12px;">ì¶”ì„¸ ê°•ë„:</span>
                                        <span style="font-size: 12px; font-weight: 700;" id="regime-trend">-</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between;">
                                        <span style="font-size: 12px;">ì‹œì¥ ì‹¬ë¦¬:</span>
                                        <span style="font-size: 12px; font-weight: 700;" id="regime-sentiment">-</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <button onclick="detectRegime()" style="width: 100%; padding: 12px; border-radius: 6px; border: none; background: var(--color-primary); color: white; font-weight: 600; cursor: pointer;">
                            <i class="fas fa-sync-alt"></i> ë ˆì§ ê°ì§€ ì‹¤í–‰
                        </button>
                        <div style="margin-top: 20px; padding: 20px; background: var(--bg-secondary); border-radius: 8px;">
                            <h4 style="font-size: 13px; margin-bottom: 15px;">ì¶”ì²œ ì „ëµ</h4>
                            <div id="regime-recommendations" style="font-size: 12px; color: var(--text-secondary);">
                                ë ˆì§ ê°ì§€ë¥¼ ì‹¤í–‰í•˜ì—¬ ì¶”ì²œ ì „ëµì„ í™•ì¸í•˜ì„¸ìš”.
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- Right Panel: 3-Column Grid -->
        <aside class="right-panel">
            <!-- Holdings Section -->
            <div class="right-panel-section">
                <div class="section-title">
                    <i class="fas fa-briefcase"></i> ë³´ìœ í˜„í™©
                </div>
                <div id="portfolio-summary" class="compact-card">
                    <div class="loading">
                        <div class="spinner"></div>
                        <p style="margin-top: 10px; font-size: 12px;">í¬íŠ¸í´ë¦¬ì˜¤ ë¡œë”© ì¤‘...</p>
                    </div>
                </div>
            </div>

            <!-- Program Monitoring Section -->
            <div class="right-panel-section">
                <div class="section-title">
                    <i class="fas fa-desktop"></i> í”„ë¡œê·¸ë¨ ëª¨ë‹ˆí„°
                </div>
                <div id="program-monitor" class="compact-card">
                    <!-- Scan Progress -->
                    <div style="margin-bottom: 12px; padding-bottom: 12px; border-bottom: 1px solid var(--border-color);">
                        <div style="font-size: 10px; color: var(--text-muted); margin-bottom: 6px;">ìŠ¤ìº” ìƒíƒœ</div>
                        <div id="scan-status" style="font-size: 11px; color: var(--text-secondary);">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                                <span>í˜„ì¬ ì „ëµ:</span>
                                <span id="current-strategy" style="color: var(--color-primary); font-weight: 600;">-</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                                <span>í›„ë³´ ì¢…ëª©:</span>
                                <span id="total-candidates" style="color: var(--text-primary); font-weight: 600;">0ê°œ</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                                <span>ê²€í†  ì¤‘:</span>
                                <span id="reviewing-stock" style="color: var(--color-info); font-weight: 600;">-</span>
                            </div>
                            <div style="display: flex; justify-content: space-between;">
                                <span>ìŠ¹ì¸/íƒˆë½:</span>
                                <span><span id="approved-count" style="color: var(--color-success); font-weight: 600;">0</span> / <span id="rejected-count" style="color: var(--color-danger); font-weight: 600;">0</span></span>
                            </div>
                        </div>
                    </div>

                    <!-- Recent Activities -->
                    <div>
                        <div style="font-size: 10px; color: var(--text-muted); margin-bottom: 6px;">ì‹œìŠ¤í…œ í™œë™</div>
                        <div id="system-activities" style="max-height: 200px; overflow-y: auto;">
                            <div style="text-align: center; padding: 15px; color: var(--text-secondary); font-size: 11px;">ë¡œë”© ì¤‘...</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- AI Candidates Section -->
            <div class="right-panel-section">
                <div class="section-title">
                    <i class="fas fa-robot"></i> AI ë§¤ìˆ˜ í›„ë³´
                </div>
                <div id="candidates-list" class="compact-card">
                    <div class="loading">
                        <div class="spinner"></div>
                        <p style="margin-top: 10px; font-size: 12px;">í›„ë³´ ì¢…ëª© ë¶„ì„ ì¤‘...</p>
                    </div>
                </div>
            </div>
        </aside>
    </div>

    <script>
        let socket;
        let mainChart;
        let candlestickSeries;
        let paperEquityChart;
        let currentTab = 0;

        // Tab Switching
        function switchTab(index) {
            const tabs = document.querySelectorAll('.tab');
            const contents = document.querySelectorAll('.tab-content');

            tabs.forEach((tab, i) => {
                if (i === index) {
                    tab.classList.add('active');
                    contents[i].classList.add('active');
                } else {
                    tab.classList.remove('active');
                    contents[i].classList.remove('active');
                }
            });

            currentTab = index;

            // Load tab-specific data
            if (index === 1) {
                loadAIAnalysis();
            } else if (index === 2) {
                loadPaperTradingData();
            }
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            initializeSocket();
            initializeChart();
            loadAllData();
            initializePaperEquityChart();
            initializeStockSearch();

            // Auto-refresh every 3 seconds
            setInterval(loadAllData, 3000);

            // AI analysis every 30 seconds
            setInterval(loadAIAnalysis, 30000);

            // Paper trading update every 5 seconds
            setInterval(loadPaperTradingData, 5000);
        });

        // WebSocket
        function initializeSocket() {
            socket = io();

            socket.on('connect', function() {
                console.log('Connected to server');
                showToast('âœ… ì„œë²„ ì—°ê²° ì™„ë£Œ', 'success');
            });

            socket.on('status_update', function(data) {
                console.log('Status update:', data);
            });

            socket.on('price_update', function(data) {
                if (candlestickSeries && data.price) {
                    updateChartPrice(data);
                }
            });

            socket.on('trade_executed', function(data) {
                showToast(`ğŸ”” ${data.action} ì£¼ë¬¸ ì²´ê²°: ${data.stock_name}`, 'info');
                loadAllData();
            });
        }

        // Initialize Chart
        function initializeChart() {
            // Use advanced chart if available (new indicator-enabled chart)
            if (typeof AdvancedTradingChart !== 'undefined') {
                console.log('Using Advanced Trading Chart with indicators');
                window.advancedChart = new AdvancedTradingChart('main-chart');
                window.advancedChart.initialize();
                window.advancedChart.loadData('005930');
                return;
            }

            // Fallback to basic chart (original code)
            console.log('Using basic chart (fallback)');
            const chartContainer = document.getElementById('main-chart');
            mainChart = LightweightCharts.createChart(chartContainer, {
                width: chartContainer.clientWidth,
                height: 400,
                layout: {
                    background: { color: '#1e2139' },
                    textColor: '#9ca3af',
                },
                grid: {
                    vertLines: { color: '#2d3250' },
                    horzLines: { color: '#2d3250' },
                },
                crosshair: {
                    mode: LightweightCharts.CrosshairMode.Normal,
                },
                rightPriceScale: {
                    borderColor: '#2d3250',
                },
                timeScale: {
                    borderColor: '#2d3250',
                    timeVisible: true,
                },
            });

            candlestickSeries = mainChart.addCandlestickSeries({
                upColor: '#10b981',
                downColor: '#ef4444',
                borderVisible: false,
                wickUpColor: '#10b981',
                wickDownColor: '#ef4444',
            });

            window.addEventListener('resize', () => {
                mainChart.applyOptions({ width: chartContainer.clientWidth });
            });

            // Load initial chart data
            loadChartData('005930'); // Default: Samsung
        }

        // Load Chart Data from Kiwoom API
        async function loadChartData(stockCode) {
            try {
                // If advanced chart is available, use it
                if (window.advancedChart) {
                    await window.advancedChart.loadData(stockCode);
                    return;
                }

                // Fallback to basic chart
                const response = await fetch(`/api/chart/${stockCode}`);
                const data = await response.json();

                if (data.success && data.data && data.data.length > 0) {
                    candlestickSeries.setData(data.data);

                    // Add trading signals
                    if (data.signals) {
                        candlestickSeries.setMarkers(data.signals);
                    }

                    document.getElementById('chart-stock-name').textContent = data.name || stockCode;
                    if (data.current_price) {
                        document.getElementById('chart-price').textContent = 'â‚©' + formatNumber(data.current_price);
                    }
                } else if (!data.success) {
                    // ì—ëŸ¬ ë°œìƒ ì‹œ ì‚¬ìš©ìì—ê²Œ ì•Œë¦¼
                    console.error('Chart load error:', data.error);
                    document.getElementById('chart-stock-name').textContent = `ì°¨íŠ¸ ë¡œë”© ì‹¤íŒ¨: ${stockCode}`;
                    alert(`ì°¨íŠ¸ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ${data.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'}`);
                } else {
                    // ë°ì´í„°ê°€ ë¹„ì–´ìˆì„ ë•Œ
                    console.warn('No chart data available for:', stockCode);
                    document.getElementById('chart-stock-name').textContent = `ë°ì´í„° ì—†ìŒ: ${stockCode}`;
                }
            } catch (error) {
                console.error('Chart data error:', error);
                alert('ì°¨íŠ¸ ë°ì´í„° ìš”ì²­ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }

        // Update chart with real-time price
        function updateChartPrice(data) {
            const update = {
                time: Math.floor(Date.now() / 1000),
                open: data.price,
                high: data.price,
                low: data.price,
                close: data.price
            };
            candlestickSeries.update(update);
            document.getElementById('chart-price').textContent = 'â‚©' + formatNumber(data.price);
        }

        // Load All Data
        async function loadAllData() {
            try {
                const [account, positions, candidates, status, activity, connections, wsSubscriptions, virtualTrades, realHoldings] = await Promise.all([
                    fetch('/api/account').then(r => r.json()),
                    fetch('/api/positions').then(r => r.json()),
                    fetch('/api/candidates').then(r => r.json()),
                    fetch('/api/status').then(r => r.json()),
                    fetch('/api/trading-activity').then(r => r.json()),
                    fetch('/api/system-connections').then(r => r.json()),
                    fetch('/api/websocket/subscriptions').then(r => r.json()).catch(() => ({success: false, data: {price: [], orderbook: [], execution: [], total: 0}})),
                    fetch('/api/virtual-trades').then(r => r.json()).catch(() => ({success: false})),
                    fetch('/api/portfolio/real-holdings').then(r => r.json()).catch(() => ({success: false, data: []}))
                ]);

                // v5.3: Check if bot is connected
                const isBotConnected = account && account.total_assets !== undefined && (connections.rest_api || connections.websocket || connections.gemini);

                if (!isBotConnected && account.total_assets === 0) {
                    showBotDisconnectedWarning();
                }

                updateAccount(account);
                updateStatus(status);
                updateConnectionStatus(connections);

                // Update compact right panel sections
                updatePortfolioSummary(account, positions);
                updateProgramMonitor();  // New: Program monitoring
                updateCandidatesCompact(candidates);

                // v5.1: Update new sections
                updateWebSocketSubscriptions(wsSubscriptions);
                updateVirtualTradesHistory(virtualTrades);
                updateRealHoldingsTable(realHoldings);
            } catch (error) {
                console.error('Error loading data:', error);
            }
        }

        // v5.3: Show warning when bot is not connected
        let warningShown = false;
        function showBotDisconnectedWarning() {
            if (warningShown) return;
            warningShown = true;

            // Update status badge
            const statusBadge = document.getElementById('status-badge');
            if (statusBadge) {
                statusBadge.className = 'status-badge disconnected';
                statusBadge.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Bot ë¯¸ì—°ê²°';
            }

            // Show warning in portfolio-summary
            const portfolioSummary = document.getElementById('portfolio-summary');
            if (portfolioSummary) {
                portfolioSummary.innerHTML = `
                    <div style="padding: 20px; text-align: center; color: var(--color-warning);">
                        <i class="fas fa-exclamation-triangle" style="font-size: 32px; margin-bottom: 10px;"></i>
                        <div style="font-size: 14px; font-weight: 600; margin-bottom: 8px;">Trading Bot ë¯¸ì—°ê²°</div>
                        <div style="font-size: 11px; color: var(--text-secondary); line-height: 1.4;">
                            ëŒ€ì‹œë³´ë“œë§Œ ì‹¤í–‰ ì¤‘ì…ë‹ˆë‹¤.<br>
                            <code style="background: var(--bg-secondary); padding: 2px 6px; border-radius: 4px;">python main.py</code>ë¥¼ ì‹¤í–‰í•˜ì„¸ìš”.
                        </div>
                    </div>
                `;
            }

            // Show warning in candidates-list
            const candidatesList = document.getElementById('candidates-list');
            if (candidatesList) {
                candidatesList.innerHTML = `
                    <div style="padding: 20px; text-align: center; color: var(--text-secondary); font-size: 11px;">
                        Bot ì—°ê²° í›„ í›„ë³´ ì¢…ëª©ì´ í‘œì‹œë©ë‹ˆë‹¤.
                    </div>
                `;
            }
        }

        // Update Connection Status
        function updateConnectionStatus(data) {
            // REST API
            updateSingleConnection('conn-rest-api', data.rest_api, 'REST API');

            // WebSocket
            updateSingleConnection('conn-websocket', data.websocket, 'WebSocket');

            // Gemini AI
            updateSingleConnection('conn-gemini', data.gemini, 'Gemini AI');

            // Test Mode (í™œì„±=íŒŒë€ìƒ‰, ë¹„í™œì„±=ë¹¨ê°„ìƒ‰)
            const testModeEl = document.getElementById('conn-testmode');
            if (testModeEl) {
                testModeEl.className = 'connection-status ' + (data.test_mode ? 'active' : 'disconnected');
                testModeEl.querySelector('span').textContent = data.test_mode ? 'í™œì„±' : 'ë¹„í™œì„±';
            }
        }

        function updateSingleConnection(elementId, isConnected, label) {
            const el = document.getElementById(elementId);
            if (!el) return;

            if (isConnected) {
                el.className = 'connection-status connected';
                el.querySelector('span').textContent = 'ì—°ê²°ë¨';
            } else {
                el.className = 'connection-status disconnected';
                el.querySelector('span').textContent = 'ëŠê¹€';
            }
        }

        function updateAccount(data) {
            document.getElementById('total-assets').textContent = 'â‚©' + formatNumber(data.total_assets || 0);
            document.getElementById('cash').textContent = 'â‚©' + formatNumber(data.cash || 0);
            document.getElementById('stock-value').textContent = 'â‚©' + formatNumber(data.stock_value || 0);

            const pl = data.profit_loss || 0;
            const plElement = document.getElementById('profit-loss');
            plElement.textContent = (pl >= 0 ? '+' : '') + 'â‚©' + formatNumber(Math.abs(pl));
            plElement.style.color = pl >= 0 ? 'var(--color-success)' : 'var(--color-danger)';
        }

        function updatePositions(positions) {
            const container = document.getElementById('holdings-list');

            if (!positions || positions.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 15px; color: var(--text-secondary); font-size: 12px;">ë³´ìœ  ì¢…ëª© ì—†ìŒ</div>';
                return;
            }

            let html = '';
            positions.forEach(p => {
                const plColor = p.profit_loss >= 0 ? 'var(--color-success)' : 'var(--color-danger)';
                html += `
                    <div style="padding: 8px; border-bottom: 1px solid var(--border-color); cursor: pointer;" onclick="loadChartData('${p.code}')">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                            <strong style="font-size: 12px;">${p.name}</strong>
                            <span style="color: ${plColor}; font-weight: 600; font-size: 12px;">
                                ${p.profit_loss >= 0 ? '+' : ''}${p.profit_loss_percent.toFixed(2)}%
                            </span>
                        </div>
                        <div style="font-size: 11px; color: var(--text-secondary);">
                            ${p.quantity}ì£¼ Ã— â‚©${formatNumber(p.current_price)}
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        function updateCandidates(candidates) {
            const container = document.getElementById('candidates-list');

            if (!candidates || candidates.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 15px; color: var(--text-secondary); font-size: 12px;">í›„ë³´ ì¢…ëª© ì—†ìŒ</div>';
                return;
            }

            let html = '';
            candidates.forEach(c => {
                html += `
                    <div class="candidate-item" onclick="loadChartData('${c.code}')">
                        <div class="candidate-header">
                            <div class="candidate-name">${c.name}</div>
                            <div class="candidate-score">${c.ai_score.toFixed(1)}</div>
                        </div>
                        <div class="candidate-info">
                            ${c.code} Â· â‚©${formatNumber(c.price)}
                        </div>
                        <div class="candidate-signals">
                            <span class="signal-badge buy">${c.signal || 'BUY'}</span>
                            <span class="signal-badge" style="background: rgba(59, 130, 246, 0.1); color: var(--color-primary);">
                                ì‹ ë¢°ë„ ${Math.round((c.confidence || 0.85) * 100)}%
                            </span>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        function updateStatus(data) {
            if (data && data.scanning) {
                const scanningCount = document.getElementById('scanning-count');
                const analyzedCount = document.getElementById('analyzed-count');

                if (scanningCount) {
                    scanningCount.textContent = data.scanning.fast_scan?.count || 0;
                }
                if (analyzedCount) {
                    analyzedCount.textContent = data.scanning.ai_scan?.count || 0;
                }
            }
        }

        function updateTradingActivity(data) {
            const container = document.getElementById('trading-activity');

            if (!data || !data.activities || data.activities.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 15px; color: var(--text-secondary); font-size: 12px;">ë§¤ë§¤ í™œë™ ì—†ìŒ</div>';
                return;
            }

            let html = '';
            data.activities.slice(0, 5).forEach(act => {
                const typeClass = act.type === 'BUY' ? 'buy' : 'sell';
                html += `
                    <div class="activity-item ${typeClass}">
                        <div class="activity-time">${act.time}</div>
                        <div class="activity-text">${act.message}</div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        // Update compact sections in right panel
        function updatePortfolioSummary(account, positions) {
            const container = document.getElementById('portfolio-summary');

            if (!account) {
                container.innerHTML = '<div style="text-align: center; padding: 15px; color: var(--text-secondary); font-size: 11px;">ë°ì´í„° ì—†ìŒ</div>';
                return;
            }

            const totalAssets = account.total_assets || 0;
            const cash = account.cash || 0;
            const stockValue = account.stock_value || 0;
            const pl = account.profit_loss || 0;
            const plColor = pl >= 0 ? 'var(--color-success)' : 'var(--color-danger)';

            let html = `
                <div style="margin-bottom: 12px; padding-bottom: 10px; border-bottom: 1px solid var(--border-color);">
                    <div style="font-size: 11px; color: var(--text-secondary); margin-bottom: 4px;">ì´ ìì‚°</div>
                    <div style="font-size: 16px; font-weight: 700;">â‚©${formatNumber(totalAssets)}</div>
                </div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                    <div>
                        <div style="font-size: 10px; color: var(--text-secondary);">í˜„ê¸ˆ</div>
                        <div style="font-size: 12px; font-weight: 600;">â‚©${formatNumber(cash)}</div>
                    </div>
                    <div>
                        <div style="font-size: 10px; color: var(--text-secondary);">ì£¼ì‹</div>
                        <div style="font-size: 12px; font-weight: 600;">â‚©${formatNumber(stockValue)}</div>
                    </div>
                </div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 10px; padding: 6px; background: rgba(59, 130, 246, 0.05); border-radius: 4px;">
                    <div style="font-size: 10px; color: var(--text-secondary);">ìˆ˜ìµ/ì†ì‹¤</div>
                    <div style="font-size: 12px; font-weight: 700; color: ${plColor};">
                        ${pl >= 0 ? '+' : ''}â‚©${formatNumber(Math.abs(pl))}
                    </div>
                </div>
            `;

            // Add top 3 positions
            if (positions && positions.length > 0) {
                html += '<div style="border-top: 1px solid var(--border-color); padding-top: 10px;">';
                html += '<div style="font-size: 10px; color: var(--text-secondary); margin-bottom: 6px;">ì£¼ìš” ë³´ìœ ì¢…ëª©</div>';
                positions.slice(0, 3).forEach(p => {
                    const posPlColor = p.profit_loss >= 0 ? 'var(--color-success)' : 'var(--color-danger)';
                    html += `
                        <div style="padding: 5px; border-left: 2px solid ${posPlColor}; margin-bottom: 6px; padding-left: 6px; cursor: pointer;" onclick="loadChartData('${p.code}')">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 2px;">
                                <span style="font-size: 11px; font-weight: 600;">${p.name}</span>
                                <span style="font-size: 11px; font-weight: 700; color: ${posPlColor};">
                                    ${p.profit_loss >= 0 ? '+' : ''}${p.profit_loss_percent.toFixed(1)}%
                                </span>
                            </div>
                            <div style="font-size: 10px; color: var(--text-secondary);">
                                ${p.quantity}ì£¼ Ã— â‚©${formatNumber(p.current_price)}
                            </div>
                        </div>
                    `;
                });
                html += '</div>';
            }

            container.innerHTML = html;
        }

        async function updateProgramMonitor() {
            try {
                // Fetch scan progress
                const scanResponse = await fetch('/api/scan-progress');
                const scanData = await scanResponse.json();

                // Update scan status
                document.getElementById('current-strategy').textContent = scanData.current_strategy || 'ëŒ€ê¸° ì¤‘';
                document.getElementById('total-candidates').textContent = (scanData.total_candidates || 0) + 'ê°œ';
                document.getElementById('reviewing-stock').textContent = scanData.reviewing || '-';
                document.getElementById('approved-count').textContent = (scanData.approved || []).length;
                document.getElementById('rejected-count').textContent = (scanData.rejected || []).length;

                // Fetch recent activities
                const activitiesResponse = await fetch('/api/activities');
                const activities = await activitiesResponse.json();

                // Update system activities
                const activitiesContainer = document.getElementById('system-activities');
                if (!activities || activities.length === 0) {
                    activitiesContainer.innerHTML = '<div style="text-align: center; padding: 15px; color: var(--text-secondary); font-size: 11px;">ì‹œìŠ¤í…œ í™œë™ ì—†ìŒ</div>';
                    return;
                }

                let html = '';
                activities.slice(0, 8).forEach(act => {
                    // Levelì— ë”°ë¥¸ ìƒ‰ìƒ ì„¤ì •
                    let levelColor = 'var(--text-secondary)';
                    let levelIcon = 'fa-info-circle';
                    if (act.level === 'success') {
                        levelColor = 'var(--color-success)';
                        levelIcon = 'fa-check-circle';
                    } else if (act.level === 'error') {
                        levelColor = 'var(--color-danger)';
                        levelIcon = 'fa-exclamation-circle';
                    } else if (act.level === 'warning') {
                        levelColor = 'var(--color-warning)';
                        levelIcon = 'fa-exclamation-triangle';
                    }

                    // Typeì— ë”°ë¥¸ ë°°ê²½ìƒ‰
                    let bgColor = 'rgba(255, 255, 255, 0.02)';
                    if (act.type === 'BUY') {
                        bgColor = 'rgba(16, 185, 129, 0.05)';
                    } else if (act.type === 'SELL') {
                        bgColor = 'rgba(239, 68, 68, 0.05)';
                    }

                    html += `
                        <div style="padding: 8px; background: ${bgColor}; border-radius: 4px; margin-bottom: 6px; border-left: 3px solid ${levelColor};">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 3px;">
                                <div style="font-size: 9px; color: var(--text-muted);">${act.time}</div>
                                <i class="fas ${levelIcon}" style="font-size: 9px; color: ${levelColor};"></i>
                            </div>
                            <div style="font-size: 10px; color: var(--text-primary); line-height: 1.4;">${act.message}</div>
                        </div>
                    `;
                });

                activitiesContainer.innerHTML = html;
            } catch (error) {
                console.error('Program monitor update error:', error);
            }
        }

        function updateCandidatesCompact(candidates) {
            const container = document.getElementById('candidates-list');

            if (!candidates || candidates.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 15px; color: var(--text-secondary); font-size: 11px;">í›„ë³´ ì¢…ëª© ì—†ìŒ</div>';
                return;
            }

            let html = '';
            candidates.slice(0, 8).forEach(c => {
                html += `
                    <div style="padding: 8px; border: 1px solid var(--border-color); border-radius: 6px; margin-bottom: 8px; cursor: pointer; transition: all 0.2s;"
                         onclick="loadChartData('${c.code}')"
                         onmouseover="this.style.borderColor='var(--color-primary)'; this.style.transform='translateY(-1px)'"
                         onmouseout="this.style.borderColor='var(--border-color)'; this.style.transform='translateY(0)'">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                            <div style="font-size: 12px; font-weight: 600;">${c.name}</div>
                            <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 2px 6px; border-radius: 4px; font-size: 10px; font-weight: 600;">
                                ${c.ai_score.toFixed(1)}
                            </div>
                        </div>
                        <div style="font-size: 10px; color: var(--text-secondary); margin-bottom: 4px;">
                            ${c.code} Â· â‚©${formatNumber(c.price)}
                        </div>
                        <div style="display: flex; gap: 4px; flex-wrap: wrap;">
                            <span style="padding: 2px 6px; border-radius: 3px; font-size: 9px; font-weight: 600; background: rgba(16, 185, 129, 0.1); color: var(--color-success);">
                                ${c.signal || 'BUY'}
                            </span>
                            <span style="padding: 2px 6px; border-radius: 3px; font-size: 9px; font-weight: 600; background: rgba(59, 130, 246, 0.1); color: var(--color-primary);">
                                ${Math.round((c.confidence || 0.85) * 100)}%
                            </span>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        // Load AI Analysis
        async function loadAIAnalysis() {
            try {
                const response = await fetch('/api/ai/auto-analysis');
                const data = await response.json();

                if (data.success) {
                    // Update quick metrics
                    if (data.portfolio) {
                        document.getElementById('ai-portfolio-score').textContent = data.portfolio.score.toFixed(1) + '/10';
                        document.getElementById('ai-portfolio-desc').textContent = data.portfolio.health || 'ì–‘í˜¸';
                    }

                    if (data.sentiment) {
                        document.getElementById('ai-sentiment').textContent = data.sentiment.sentiment || '-';
                        document.getElementById('ai-sentiment-desc').textContent = `ì ìˆ˜: ${data.sentiment.overall_sentiment}/10`;
                    }

                    if (data.risk) {
                        document.getElementById('ai-risk').textContent = data.risk.risk_level || '-';
                        document.getElementById('ai-risk-desc').textContent = `VaR: ${formatNumber(data.risk.var)}ì›`;
                    }

                    // Update detailed analysis
                    updatePortfolioAnalysis(data.portfolio);
                    updateRiskAnalysis(data.risk);
                    updateMultiAgentConsensus(data.consensus);
                }
            } catch (error) {
                console.error('AI analysis error:', error);
            }
        }

        function updatePortfolioAnalysis(data) {
            const container = document.getElementById('portfolio-analysis');
            if (!data) {
                container.innerHTML = '<div class="loading"><p style="font-size: 12px;">ë°ì´í„° ì—†ìŒ</p></div>';
                return;
            }

            let html = '';
            (data.recommendations || []).slice(0, 5).forEach(rec => {
                html += `<div class="metric-row"><span class="metric-label">${rec}</span></div>`;
            });

            container.innerHTML = html || '<div style="font-size: 12px; color: var(--text-secondary);">ê¶Œì¥ì‚¬í•­ ì—†ìŒ</div>';
        }

        function updateRiskAnalysis(data) {
            const container = document.getElementById('risk-analysis');
            if (!data) {
                container.innerHTML = '<div class="loading"><p style="font-size: 12px;">ë°ì´í„° ì—†ìŒ</p></div>';
                return;
            }

            let html = `
                <div class="metric-row">
                    <span class="metric-label">VaR (95%)</span>
                    <span class="metric-value">${formatNumber(data.var || 0)}ì›</span>
                </div>
                <div class="metric-row">
                    <span class="metric-label">CVaR</span>
                    <span class="metric-value">${formatNumber(data.cvar || 0)}ì›</span>
                </div>
                <div class="metric-row">
                    <span class="metric-label">ë³€ë™ì„±</span>
                    <span class="metric-value">${(data.volatility || 0).toFixed(1)}%</span>
                </div>
                <div class="metric-row">
                    <span class="metric-label">ìƒ¤í”„ ë¹„ìœ¨</span>
                    <span class="metric-value">${(data.sharpe_ratio || 0).toFixed(2)}</span>
                </div>
            `;

            container.innerHTML = html;
        }

        function updateMultiAgentConsensus(data) {
            const container = document.getElementById('multiagent-consensus');
            if (!data) {
                container.innerHTML = '<div class="loading"><p style="font-size: 12px;">ë°ì´í„° ì—†ìŒ</p></div>';
                return;
            }

            let html = `
                <div class="metric-row">
                    <span class="metric-label">ìµœì¢… ê²°ì •</span>
                    <span class="metric-value">${(data.final_action || 'HOLD').toUpperCase()}</span>
                </div>
                <div class="metric-row">
                    <span class="metric-label">í•©ì˜ë„</span>
                    <span class="metric-value">${((data.consensus_level || 0) * 100).toFixed(0)}%</span>
                </div>
                <div class="metric-row">
                    <span class="metric-label">ì‹ ë¢°ë„</span>
                    <span class="metric-value">${((data.confidence || 0) * 100).toFixed(0)}%</span>
                </div>
            `;

            if (data.votes) {
                html += '<div style="margin-top: 10px; font-size: 11px; color: var(--text-secondary);">íˆ¬í‘œ ê²°ê³¼:</div>';
                for (const [action, count] of Object.entries(data.votes)) {
                    html += `<div class="metric-row"><span class="metric-label">${action.toUpperCase()}</span><span>${count}í‘œ</span></div>`;
                }
            }

            container.innerHTML = html;
        }

        // Initialize Paper Equity Chart
        function initializePaperEquityChart() {
            const ctx = document.getElementById('paper-equity-chart');
            if (!ctx) {
                console.log('Paper equity chart canvas not found - skipping initialization');
                return;
            }

            paperEquityChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'ì†ìµ',
                        data: [],
                        borderColor: '#10b981',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        x: { display: true, grid: { color: '#2d3250' } },
                        y: { display: true, grid: { color: '#2d3250' } }
                    }
                }
            });
        }

        // Load Paper Trading Data
        async function loadPaperTradingData() {
            try {
                const response = await fetch('/api/virtual_trading/status');
                const data = await response.json();

                if (data.success && data.enabled && data.strategies) {
                    updateVirtualStrategies(data.strategies, data.best_strategy);

                    // Load recent trades
                    const tradesResponse = await fetch('/api/virtual_trading/trades?limit=20');
                    const tradesData = await tradesResponse.json();
                    if (tradesData.success) {
                        updateVirtualTrades(tradesData.trades);
                    }
                }
            } catch (error) {
                console.error('Virtual trading data error:', error);
            }
        }

        function updateVirtualStrategies(strategies, bestStrategy) {
            // Strategy name mapping
            const strategyNames = {
                'ê³µê²©ì ': 'aggressive',
                'ë³´ìˆ˜ì ': 'conservative',
                'ê· í˜•': 'balanced'
            };

            // Update best strategy banner
            if (bestStrategy) {
                document.getElementById('best-strategy-banner').style.display = 'block';
                document.getElementById('best-strategy-name').textContent = bestStrategy.name || bestStrategy;

                const bestData = strategies[bestStrategy.name || bestStrategy];
                if (bestData) {
                    const returnPct = bestData.total_pnl_rate || 0;  // Already percentage
                    document.getElementById('best-strategy-return').textContent =
                        (returnPct >= 0 ? '+' : '') + returnPct.toFixed(2) + '%';
                }
            }

            // Update each strategy card
            Object.entries(strategies).forEach(([name, summary]) => {
                const strategyId = strategyNames[name];
                if (!strategyId) return;

                const returnPct = summary.total_pnl_rate || 0;  // Already percentage
                const returnClass = returnPct >= 0 ? 'positive' : 'negative';

                document.getElementById(`${strategyId}-cash`).textContent =
                    'â‚©' + formatNumber(Math.round(summary.total_value || 0));

                const returnEl = document.getElementById(`${strategyId}-return`);
                returnEl.textContent = (returnPct >= 0 ? '+' : '') + returnPct.toFixed(2) + '%';
                returnEl.className = `metric-value ${returnClass}`;

                document.getElementById(`${strategyId}-positions`).textContent =
                    (summary.position_count || 0) + 'ê°œ';

                const winRate = summary.win_rate || 0;  // Already percentage
                document.getElementById(`${strategyId}-winrate`).textContent =
                    winRate.toFixed(1) + '%';
            });
        }

        function updateVirtualTrades(trades) {
            const container = document.getElementById('virtual-trades-list');

            if (!trades || trades.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 15px; color: var(--text-secondary); font-size: 12px;">ë§¤ë§¤ ê¸°ë¡ ì—†ìŒ</div>';
                return;
            }

            let html = '<div style="display: flex; flex-direction: column; gap: 10px;">';
            trades.slice(0, 20).forEach(trade => {
                const typeClass = trade.action === 'buy' ? 'buy' : 'sell';
                const plClass = (trade.profit_loss || 0) >= 0 ? 'positive' : 'negative';
                html += `
                    <div class="activity-item ${typeClass}" style="background: var(--bg-card); padding: 12px; border-radius: 8px; border-left: 3px solid ${trade.action === 'buy' ? '#10b981' : '#ef4444'};">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
                            <div style="font-weight: 600; color: var(--text-primary);">
                                ${trade.stock_name} (${trade.stock_code})
                            </div>
                            <div style="font-size: 11px; color: var(--text-secondary);">
                                ${trade.strategy} Â· ${trade.timestamp || trade.date}
                            </div>
                        </div>
                        <div style="display: flex; justify-content: space-between; font-size: 12px;">
                            <span style="color: var(--text-secondary);">
                                <strong style="text-transform: uppercase;">${trade.action}</strong> ${trade.quantity}ì£¼ @ â‚©${formatNumber(trade.price)}
                            </span>
                            ${trade.profit_loss !== undefined ?
                                `<span class="metric-value ${plClass}">${(trade.profit_loss >= 0 ? '+' : '')}â‚©${formatNumber(Math.abs(trade.profit_loss))} (${trade.profit_loss_pct >= 0 ? '+' : ''}${trade.profit_loss_pct.toFixed(2)}%)</span>`
                                : ''}
                        </div>
                    </div>
                `;
            });
            html += '</div>';

            container.innerHTML = html;
        }

        // Toggle Strategy Position Details
        async function toggleStrategyDetails(strategyName) {
            const strategyNames = {
                'ê³µê²©ì ': 'aggressive',
                'ë³´ìˆ˜ì ': 'conservative',
                'ê· í˜•': 'balanced'
            };

            const strategyId = strategyNames[strategyName];
            const detailsDiv = document.getElementById(`${strategyId}-details`);
            const positionsDiv = document.getElementById(`${strategyId}-positions-list`);

            // Toggle display
            if (detailsDiv.style.display === 'none' || !detailsDiv.style.display) {
                detailsDiv.style.display = 'block';

                // Load positions
                positionsDiv.innerHTML = '<div style="text-align: center; padding: 10px;"><div class="spinner"></div></div>';

                try {
                    const response = await fetch(`/api/virtual_trading/account/${strategyName}`);
                    const data = await response.json();

                    if (data.success && data.positions) {
                        if (data.positions.length === 0) {
                            positionsDiv.innerHTML = '<div style="text-align: center; padding: 10px; color: var(--text-secondary); font-size: 11px;">ë³´ìœ  í¬ì§€ì…˜ ì—†ìŒ</div>';
                        } else {
                            let html = '<div style="display: flex; flex-direction: column; gap: 8px;">';
                            data.positions.forEach(pos => {
                                const plClass = (pos.unrealized_pnl || 0) >= 0 ? 'positive' : 'negative';
                                html += `
                                    <div style="background: var(--bg-primary); padding: 10px; border-radius: 6px; font-size: 11px;">
                                        <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                            <span style="font-weight: 600;">${pos.stock_name} (${pos.stock_code})</span>
                                            <span class="metric-value ${plClass}">${(pos.unrealized_pnl >= 0 ? '+' : '')}${pos.unrealized_pnl_rate.toFixed(2)}%</span>
                                        </div>
                                        <div style="display: flex; justify-content: space-between; color: var(--text-secondary);">
                                            <span>${pos.quantity}ì£¼ @ â‚©${formatNumber(pos.avg_price)}</span>
                                            <span>í˜„ì¬ â‚©${formatNumber(pos.current_price || pos.avg_price)}</span>
                                        </div>
                                    </div>
                                `;
                            });
                            html += '</div>';
                            positionsDiv.innerHTML = html;
                        }
                    } else {
                        positionsDiv.innerHTML = '<div style="text-align: center; padding: 10px; color: var(--error); font-size: 11px;">ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨</div>';
                    }
                } catch (error) {
                    console.error('Position load error:', error);
                    positionsDiv.innerHTML = '<div style="text-align: center; padding: 10px; color: var(--error); font-size: 11px;">ì˜¤ë¥˜ ë°œìƒ</div>';
                }
            } else {
                detailsDiv.style.display = 'none';
            }
        }

        // Utility Functions
        function formatNumber(num) {
            return Math.abs(num).toLocaleString('ko-KR');
        }

        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.textContent = message;
            document.body.appendChild(toast);

            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // Market Explorer Functions
        document.getElementById('market-filter-type').addEventListener('change', function() {
            const sortContainer = document.getElementById('sort-option-container');
            if (this.value === 'price-change') {
                sortContainer.style.display = 'block';
            } else {
                sortContainer.style.display = 'none';
            }
        });

        async function loadMarketData() {
            try {
                const filterType = document.getElementById('market-filter-type').value;
                const market = document.getElementById('market-filter-market').value;
                const limit = document.getElementById('market-filter-limit').value;
                const sort = document.getElementById('market-filter-sort').value;

                const resultsDiv = document.getElementById('market-results');
                resultsDiv.innerHTML = '<div class="loading"><div class="spinner"></div><p>ë°ì´í„° ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p></div>';

                let apiUrl = '';
                let params = `?market=${market}&limit=${limit}`;

                if (filterType === 'volume') {
                    apiUrl = '/api/market/volume-rank' + params;
                    document.getElementById('market-results-title').textContent = 'ê±°ë˜ëŸ‰ ìˆœìœ„';
                } else if (filterType === 'trading-value') {
                    apiUrl = '/api/market/trading-value-rank' + params;
                    document.getElementById('market-results-title').textContent = 'ê±°ë˜ëŒ€ê¸ˆ ìˆœìœ„';
                } else if (filterType === 'price-change') {
                    apiUrl = '/api/market/price-change-rank' + params + `&sort=${sort}`;
                    document.getElementById('market-results-title').textContent = sort === 'rise' ? 'ìƒìŠ¹ë¥  ìˆœìœ„' : 'í•˜ë½ë¥  ìˆœìœ„';
                }

                const response = await fetch(apiUrl);
                const result = await response.json();

                if (result.success && result.data && result.data.length > 0) {
                    displayMarketResults(result.data, filterType);
                    document.getElementById('market-results-count').textContent = `${result.data.length}ê°œ ì¢…ëª©`;
                } else {
                    resultsDiv.innerHTML = '<div style="padding: 40px; text-align: center;"><p style="font-size: 12px; color: var(--text-secondary);">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</p></div>';
                }
            } catch (error) {
                console.error('Market data error:', error);
                document.getElementById('market-results').innerHTML = '<div style="padding: 40px; text-align: center;"><p style="font-size: 12px; color: var(--error-color);">ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨</p></div>';
            }
        }

        function displayMarketResults(data, filterType) {
            const resultsDiv = document.getElementById('market-results');

            let tableHTML = `
                <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="border-bottom: 1px solid var(--border-color); background: var(--bg-secondary);">
                            <th style="padding: 10px; text-align: center; font-size: 11px; color: var(--text-secondary);">ìˆœìœ„</th>
                            <th style="padding: 10px; text-align: left; font-size: 11px; color: var(--text-secondary);">ì¢…ëª©ëª…</th>
                            <th style="padding: 10px; text-align: left; font-size: 11px; color: var(--text-secondary);">ì¢…ëª©ì½”ë“œ</th>
                            <th style="padding: 10px; text-align: right; font-size: 11px; color: var(--text-secondary);">í˜„ì¬ê°€</th>
                            <th style="padding: 10px; text-align: right; font-size: 11px; color: var(--text-secondary);">ë“±ë½ë¥ </th>
                            <th style="padding: 10px; text-align: right; font-size: 11px; color: var(--text-secondary);">ê±°ë˜ëŸ‰</th>
                            <th style="padding: 10px; text-align: right; font-size: 11px; color: var(--text-secondary);">ê±°ë˜ëŒ€ê¸ˆ</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            data.forEach((item, index) => {
                const changeRate = parseFloat(item.change_rate || item.rate || 0);
                const changeClass = changeRate > 0 ? 'positive' : (changeRate < 0 ? 'negative' : '');
                const changeSymbol = changeRate > 0 ? '+' : '';

                const price = item.price || item.current_price || 0;
                const volume = item.volume || item.trading_volume || 0;
                const tradingValue = item.trading_value || item.trading_amount || 0;

                tableHTML += `
                    <tr style="border-bottom: 1px solid var(--border-color); transition: background 0.2s;" onmouseover="this.style.background='var(--bg-secondary)'" onmouseout="this.style.background='transparent'">
                        <td style="padding: 10px; text-align: center; font-size: 12px;">${index + 1}</td>
                        <td style="padding: 10px; text-align: left; font-size: 12px; font-weight: 600;">${item.name || item.stock_name || '-'}</td>
                        <td style="padding: 10px; text-align: left; font-size: 11px; color: var(--text-secondary); font-family: monospace;">${item.code || item.stock_code || '-'}</td>
                        <td style="padding: 10px; text-align: right; font-size: 12px; font-weight: 600;">â‚©${formatNumber(price)}</td>
                        <td style="padding: 10px; text-align: right; font-size: 12px; font-weight: 600;" class="${changeClass}">${changeSymbol}${changeRate.toFixed(2)}%</td>
                        <td style="padding: 10px; text-align: right; font-size: 11px; color: var(--text-secondary);">${formatNumber(volume)}</td>
                        <td style="padding: 10px; text-align: right; font-size: 11px; color: var(--text-secondary);">${formatNumber(tradingValue)}</td>
                    </tr>
                `;
            });

            tableHTML += `
                    </tbody>
                </table>
            `;

            resultsDiv.innerHTML = tableHTML;
        }

        // ========================================================================
        // v4.2 NEW FEATURES
        // ========================================================================

        // Portfolio Optimization (v4.2)
        async function runPortfolioOptimization() {
            const method = document.getElementById('portfolio-method').value;
            const targetReturn = parseFloat(document.getElementById('portfolio-target-return').value);
            const riskLevel = document.getElementById('portfolio-risk-level').value;

            try {
                const response = await fetch('/api/v4.2/portfolio/optimize', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        method: method,
                        target_return: targetReturn / 100,
                        risk_level: riskLevel
                    })
                });

                const data = await response.json();

                if (data.success) {
                    const results = data.result;
                    document.getElementById('portfolio-results').style.display = 'block';
                    document.getElementById('portfolio-exp-return').textContent =
                        (results.expected_return * 100).toFixed(2) + '%';
                    document.getElementById('portfolio-volatility').textContent =
                        (results.volatility * 100).toFixed(2) + '%';
                    document.getElementById('portfolio-sharpe').textContent =
                        results.sharpe_ratio.toFixed(2);

                    // Display allocation
                    let allocationHTML = '<div style="display: grid; gap: 8px;">';
                    for (const [stock, weight] of Object.entries(results.weights)) {
                        const percentage = (weight * 100).toFixed(1);
                        allocationHTML += `
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <span style="font-size: 12px;">${stock}</span>
                                <div style="flex: 1; margin: 0 10px; height: 20px; background: var(--bg-primary); border-radius: 10px; overflow: hidden;">
                                    <div style="width: ${percentage}%; height: 100%; background: var(--color-primary);"></div>
                                </div>
                                <span style="font-size: 12px; font-weight: 700; width: 50px; text-align: right;">${percentage}%</span>
                            </div>
                        `;
                    }
                    allocationHTML += '</div>';
                    document.getElementById('portfolio-allocation').innerHTML = allocationHTML;
                } else {
                    alert('í¬íŠ¸í´ë¦¬ì˜¤ ìµœì í™” ì‹¤íŒ¨: ' + (data.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
                }
            } catch (error) {
                console.error('Portfolio optimization error:', error);
                alert('í¬íŠ¸í´ë¦¬ì˜¤ ìµœì í™” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }

        // Sentiment Analysis (v4.2)
        async function analyzeSentiment() {
            const stockCode = document.getElementById('sentiment-stock-code').value;
            if (!stockCode) {
                alert('ì¢…ëª© ì½”ë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”.');
                return;
            }

            try {
                const response = await fetch(`/api/v4.2/sentiment/${stockCode}`);
                const data = await response.json();

                if (data.success) {
                    const result = data.result;
                    document.getElementById('sentiment-results').style.display = 'block';
                    document.getElementById('sentiment-overall').textContent =
                        result.overall_sentiment.toFixed(1);
                    document.getElementById('sentiment-overall').style.color =
                        result.overall_sentiment > 6 ? 'var(--color-success)' :
                        result.overall_sentiment < 4 ? 'var(--color-danger)' : 'var(--color-warning)';
                    document.getElementById('sentiment-label').textContent = result.sentiment_label;
                    document.getElementById('sentiment-news').textContent =
                        result.news_sentiment.toFixed(1);
                    document.getElementById('sentiment-social').textContent =
                        result.social_sentiment.toFixed(1);

                    // Display news
                    let newsHTML = '<ul style="list-style: none; padding: 0; margin: 0;">';
                    result.news_articles.slice(0, 5).forEach(article => {
                        newsHTML += `
                            <li style="padding: 8px 0; border-bottom: 1px solid var(--border-color);">
                                <div style="font-size: 12px; margin-bottom: 3px;">${article.title}</div>
                                <div style="font-size: 10px; color: var(--text-muted);">${article.source} â€¢ ${article.date}</div>
                            </li>
                        `;
                    });
                    newsHTML += '</ul>';
                    document.getElementById('sentiment-news-list').innerHTML = newsHTML;
                } else {
                    alert('ê°ì„± ë¶„ì„ ì‹¤íŒ¨: ' + (data.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
                }
            } catch (error) {
                console.error('Sentiment analysis error:', error);
                alert('ê°ì„± ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }

        // Risk Assessment (v4.2)
        async function assessRisk() {
            try {
                const response = await fetch('/api/v4.2/risk/assess', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({})
                });

                const data = await response.json();

                if (data.success) {
                    const result = data.result;
                    document.getElementById('risk-var').textContent =
                        'â‚©' + formatNumber(Math.abs(result.var_95));
                    document.getElementById('risk-cvar').textContent =
                        'â‚©' + formatNumber(Math.abs(result.cvar_95));
                    document.getElementById('risk-max-loss').textContent =
                        'â‚©' + formatNumber(Math.abs(result.max_drawdown));
                    document.getElementById('risk-level').textContent = result.risk_level;
                    document.getElementById('risk-level').style.color =
                        result.risk_level === 'Low' ? 'var(--color-success)' :
                        result.risk_level === 'High' ? 'var(--color-danger)' : 'var(--color-warning)';
                } else {
                    alert('ë¦¬ìŠ¤í¬ í‰ê°€ ì‹¤íŒ¨: ' + (data.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
                }
            } catch (error) {
                console.error('Risk assessment error:', error);
                alert('ë¦¬ìŠ¤í¬ í‰ê°€ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }

        // Market Regime Detection (v4.2)
        async function detectRegime() {
            try {
                const response = await fetch('/api/v4.2/regime/detect', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({})
                });

                const data = await response.json();

                if (data.success) {
                    const result = data.result;
                    document.getElementById('regime-current').textContent = result.current_regime;
                    document.getElementById('regime-current').style.color =
                        result.current_regime === 'Bull Market' ? 'var(--color-success)' :
                        result.current_regime === 'Bear Market' ? 'var(--color-danger)' : 'var(--color-warning)';
                    document.getElementById('regime-confidence').textContent =
                        `ì‹ ë¢°ë„: ${(result.confidence * 100).toFixed(1)}%`;
                    document.getElementById('regime-volatility').textContent =
                        (result.volatility * 100).toFixed(2) + '%';
                    document.getElementById('regime-trend').textContent =
                        result.trend_strength.toFixed(2);
                    document.getElementById('regime-sentiment').textContent =
                        result.market_sentiment;

                    // Display recommendations
                    let recHTML = '<ul style="list-style: none; padding: 0; margin: 0;">';
                    result.recommended_strategies.forEach(strategy => {
                        recHTML += `
                            <li style="padding: 8px 12px; margin-bottom: 8px; background: var(--bg-primary); border-left: 3px solid var(--color-primary); border-radius: 4px;">
                                ${strategy}
                            </li>
                        `;
                    });
                    recHTML += '</ul>';
                    document.getElementById('regime-recommendations').innerHTML = recHTML;
                } else {
                    alert('ë ˆì§ ê°ì§€ ì‹¤íŒ¨: ' + (data.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
                }
            } catch (error) {
                console.error('Regime detection error:', error);
                alert('ë ˆì§ ê°ì§€ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }

        // ============================================================================
        // Stock Search Functionality
        // ============================================================================

        function initializeStockSearch() {
            const searchInput = document.getElementById('stock-search-input');
            const resultsContainer = document.getElementById('stock-search-results');
            let searchTimeout;

            if (!searchInput || !resultsContainer) return;

            // Search on input
            searchInput.addEventListener('input', function() {
                clearTimeout(searchTimeout);
                const query = this.value.trim();

                if (query.length < 1) {
                    resultsContainer.style.display = 'none';
                    return;
                }

                // Debounce search
                searchTimeout = setTimeout(() => {
                    searchStocks(query);
                }, 300);
            });

            // Hide results when clicking outside
            document.addEventListener('click', function(e) {
                if (!searchInput.contains(e.target) && !resultsContainer.contains(e.target)) {
                    resultsContainer.style.display = 'none';
                }
            });

            // Show results when focusing on input
            searchInput.addEventListener('focus', function() {
                if (resultsContainer.children.length > 0) {
                    resultsContainer.style.display = 'block';
                }
            });
        }

        async function searchStocks(query) {
            const resultsContainer = document.getElementById('stock-search-results');

            try {
                const response = await fetch(`/api/search/stocks?q=${encodeURIComponent(query)}&limit=10`);
                const data = await response.json();

                if (data.success && data.results.length > 0) {
                    let html = '';
                    data.results.forEach(stock => {
                        const changeColor = stock.change_rate >= 0 ? 'var(--color-success)' : 'var(--color-danger)';
                        const changeSign = stock.change_rate >= 0 ? '+' : '';
                        html += `
                            <div onclick="selectStock('${stock.code}', '${stock.name}')" style="padding: 10px; border-bottom: 1px solid var(--border-color); cursor: pointer; transition: background 0.2s;" onmouseover="this.style.background='var(--bg-secondary)'" onmouseout="this.style.background='transparent'">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <div>
                                        <div style="font-weight: 600; font-size: 13px;">${stock.name}</div>
                                        <div style="font-size: 11px; color: var(--text-muted);">${stock.code}</div>
                                    </div>
                                    <div style="text-align: right;">
                                        <div style="font-weight: 600; font-size: 13px;">â‚©${formatNumber(stock.price)}</div>
                                        <div style="font-size: 11px; color: ${changeColor};">${changeSign}${stock.change_rate.toFixed(2)}%</div>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                    resultsContainer.innerHTML = html;
                    resultsContainer.style.display = 'block';
                } else {
                    resultsContainer.innerHTML = '<div style="padding: 12px; text-align: center; color: var(--text-muted); font-size: 12px;">ê²€ìƒ‰ ê²°ê³¼ ì—†ìŒ</div>';
                    resultsContainer.style.display = 'block';
                }
            } catch (error) {
                console.error('Stock search error:', error);
                resultsContainer.innerHTML = '<div style="padding: 12px; text-align: center; color: var(--color-danger); font-size: 12px;">ê²€ìƒ‰ ì˜¤ë¥˜</div>';
                resultsContainer.style.display = 'block';
            }
        }

        function selectStock(code, name) {
            // Load chart for selected stock
            if (window.advancedChart) {
                advancedChart.loadData(code);
            } else {
                loadChartData(code);
            }

            // Clear search input and hide results
            document.getElementById('stock-search-input').value = '';
            document.getElementById('stock-search-results').style.display = 'none';
        }

        // v5.1: WebSocket Subscriptions Update
        function updateWebSocketSubscriptions(response) {
            if (!response.success || !response.data) {
                document.getElementById('ws-total-badge').textContent = '0';
                return;
            }

            const data = response.data;
            document.getElementById('ws-total-badge').textContent = data.total || 0;

            // í˜„ì¬ê°€ êµ¬ë…
            const priceList = document.getElementById('ws-price-list');
            if (data.price && data.price.length > 0) {
                priceList.innerHTML = data.price.map(s =>
                    `<span style="display: inline-block; margin: 2px; padding: 2px 6px; background: rgba(59, 130, 246, 0.2); border-radius: 4px; font-size: 10px;">${s.stock_name}</span>`
                ).join('');
            } else {
                priceList.textContent = 'ì—†ìŒ';
            }

            // í˜¸ê°€ êµ¬ë…
            const orderbookList = document.getElementById('ws-orderbook-list');
            if (data.orderbook && data.orderbook.length > 0) {
                orderbookList.innerHTML = data.orderbook.map(s =>
                    `<span style="display: inline-block; margin: 2px; padding: 2px 6px; background: rgba(16, 185, 129, 0.2); border-radius: 4px; font-size: 10px;">${s.stock_name}</span>`
                ).join('');
            } else {
                orderbookList.textContent = 'ì—†ìŒ';
            }

            // ì²´ê²° êµ¬ë…
            const executionList = document.getElementById('ws-execution-list');
            if (data.execution && data.execution.length > 0) {
                executionList.innerHTML = data.execution.map(s =>
                    `<span style="display: inline-block; margin: 2px; padding: 2px 6px; background: rgba(245, 158, 11, 0.2); border-radius: 4px; font-size: 10px;">${s.stock_name}</span>`
                ).join('');
            } else {
                executionList.textContent = 'ì—†ìŒ';
            }
        }

        // v5.1: Virtual Trading History Update
        function updateVirtualTradesHistory(response) {
            const container = document.getElementById('virtual-trades-list');

            if (!response.success || !response.data) {
                container.innerHTML = '<div style="text-align: center; padding: 20px; color: var(--text-secondary);">ê°€ìƒë§¤ë§¤ ë°ì´í„° ì—†ìŒ</div>';
                return;
            }

            const data = response.data;
            let html = '';
            let allTrades = [];

            // ëª¨ë“  ì „ëµì˜ ê±°ë˜ë¥¼ ëª¨ì•„ì„œ ì‹œê°„ìˆœ ì •ë ¬
            for (const [strategyName, strategyData] of Object.entries(data)) {
                const trades = strategyData.trades || [];
                trades.forEach(trade => {
                    trade.strategy = strategyName;
                    allTrades.push(trade);
                });
            }

            // ìµœì‹ ìˆœ ì •ë ¬
            allTrades.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

            if (allTrades.length === 0) {
                html = '<div style="text-align: center; padding: 20px; color: var(--text-secondary);">ê±°ë˜ ë‚´ì—­ ì—†ìŒ</div>';
            } else {
                allTrades.slice(0, 20).forEach(trade => {
                    const timestamp = trade.timestamp ? new Date(trade.timestamp).toLocaleString('ko-KR', {
                        month: '2-digit',
                        day: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit'
                    }) : 'N/A';

                    const strategyColor = trade.strategy === 'ê³µê²©ì ' ? '#ef4444' : trade.strategy === 'ë³´ìˆ˜ì ' ? '#3b82f6' : '#f59e0b';

                    if (trade.type === 'buy') {
                        html += `
                            <div style="padding: 10px; border-bottom: 1px solid var(--border-color); font-size: 12px;">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                                    <span style="color: ${strategyColor}; font-weight: 600;">[${trade.strategy}]</span>
                                    <span style="color: var(--text-muted);">${timestamp}</span>
                                </div>
                                <div>ğŸ”µ <strong>ë§¤ìˆ˜</strong> ${trade.stock_name || trade.stock_code} ${trade.quantity}ì£¼ @ â‚©${formatNumber(trade.price)}</div>
                            </div>
                        `;
                    } else {
                        const pnl = trade.realized_pnl || 0;
                        const pnlRate = trade.realized_pnl_rate || 0;
                        const pnlColor = pnl >= 0 ? 'var(--color-success)' : 'var(--color-danger)';
                        const pnlSign = pnl >= 0 ? 'âœ…' : 'âŒ';

                        html += `
                            <div style="padding: 10px; border-bottom: 1px solid var(--border-color); font-size: 12px;">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                                    <span style="color: ${strategyColor}; font-weight: 600;">[${trade.strategy}]</span>
                                    <span style="color: var(--text-muted);">${timestamp}</span>
                                </div>
                                <div>
                                    ğŸ”´ <strong>ë§¤ë„</strong> ${trade.stock_name || trade.stock_code} ${trade.quantity}ì£¼ @ â‚©${formatNumber(trade.price)}
                                    <span style="color: ${pnlColor}; font-weight: 600;">
                                        (${pnl >= 0 ? '+' : ''}â‚©${formatNumber(Math.abs(pnl))}, ${pnl >= 0 ? '+' : ''}${pnlRate.toFixed(2)}%)
                                    </span> ${pnlSign}
                                    ${trade.reason ? `<span style="color: var(--text-muted); font-size: 11px;">[${trade.reason}]</span>` : ''}
                                </div>
                            </div>
                        `;
                    }
                });
            }

            container.innerHTML = html;
        }

        // v5.1: Real Holdings with ATR Stops Update
        function updateRealHoldingsTable(response) {
            const tbody = document.getElementById('real-holdings-table');

            if (!response.success || !response.data || response.data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="10" style="text-align: center; padding: 40px; color: var(--text-secondary);">ë³´ìœ  ì¢…ëª© ì—†ìŒ</td></tr>';
                return;
            }

            const holdings = response.data;

            let html = '';
            holdings.forEach(h => {
                const stopLossDistance = h.distance_to_stop || 0;
                const takeProfitDistance = h.distance_to_target || 0;
                const plColor = h.pnl_rate >= 0 ? 'var(--color-success)' : 'var(--color-danger)';

                // Kelly & Sharpe ìƒ‰ìƒ
                const kellyColor = h.kelly_fraction > 0.15 ? 'var(--color-success)' : h.kelly_fraction > 0.05 ? 'var(--color-warning)' : 'var(--color-danger)';
                const sharpeColor = h.sharpe_ratio > 1 ? 'var(--color-success)' : h.sharpe_ratio > 0 ? 'var(--color-warning)' : 'var(--color-danger)';

                // RSI ìƒ‰ìƒ (70 ì´ìƒ ê³¼ë§¤ìˆ˜, 30 ì´í•˜ ê³¼ë§¤ë„)
                const rsiColor = h.rsi > 70 ? 'var(--color-danger)' : h.rsi < 30 ? 'var(--color-success)' : 'var(--text-primary)';

                // Risk/Reward ìƒ‰ìƒ
                const rrColor = h.risk_reward_ratio >= 2 ? 'var(--color-success)' : h.risk_reward_ratio >= 1 ? 'var(--color-warning)' : 'var(--color-danger)';

                html += `
                    <tr style="border-bottom: 1px solid var(--border-color); cursor: pointer;" onclick="loadChartData('${h.stock_code}')">
                        <td style="padding: 12px;">
                            <div style="font-weight: 600; font-size: 13px;">${h.stock_name}</div>
                            <div style="font-size: 11px; color: var(--text-muted);">${h.stock_code}</div>
                        </td>
                        <td style="padding: 12px; text-align: right;">${h.quantity}</td>
                        <td style="padding: 12px; text-align: right;">â‚©${formatNumber(h.avg_price)}</td>
                        <td style="padding: 12px; text-align: right;">â‚©${formatNumber(h.current_price)}</td>
                        <td style="padding: 12px; text-align: right;">
                            <div style="color: var(--color-danger); font-weight: 600;">â‚©${formatNumber(h.stop_loss_price)}</div>
                            <div style="font-size: 10px; color: var(--text-muted);">(${stopLossDistance >= 0 ? '+' : ''}${stopLossDistance.toFixed(1)}%)</div>
                            ${h.atr_based ? '<div style="font-size: 9px; color: var(--color-danger); margin-top: 2px;">ATR</div>' : ''}
                        </td>
                        <td style="padding: 12px; text-align: right;">
                            <div style="color: var(--color-success); font-weight: 600;">â‚©${formatNumber(h.take_profit_price)}</div>
                            <div style="font-size: 10px; color: var(--text-muted);">(${takeProfitDistance >= 0 ? '+' : ''}${takeProfitDistance.toFixed(1)}%)</div>
                            ${h.atr_based ? '<div style="font-size: 9px; color: var(--color-success); margin-top: 2px;">ATR</div>' : ''}
                        </td>
                        <td style="padding: 12px; text-align: right;">
                            <div style="color: ${plColor}; font-weight: 700; font-size: 14px;">
                                ${h.pnl_rate >= 0 ? '+' : ''}${h.pnl_rate.toFixed(2)}%
                            </div>
                            <div style="font-size: 11px; color: ${plColor};">
                                ${h.pnl >= 0 ? '+' : ''}â‚©${formatNumber(Math.abs(h.pnl))}
                            </div>
                        </td>
                        <td style="padding: 12px; text-align: right; font-weight: 600;">â‚©${formatNumber(h.eval_amount)}</td>
                        <td style="padding: 12px; text-align: right;">
                            <div style="color: ${kellyColor}; font-weight: 600; font-size: 12px;">K: ${(h.kelly_fraction * 100).toFixed(1)}%</div>
                            <div style="color: ${sharpeColor}; font-size: 11px; margin-top: 2px;">S: ${h.sharpe_ratio.toFixed(2)}</div>
                            <div style="font-size: 10px; color: var(--text-muted); margin-top: 2px;">MDD: ${h.max_drawdown.toFixed(1)}%</div>
                        </td>
                        <td style="padding: 12px; text-align: right;">
                            <div style="color: ${rsiColor}; font-weight: 600; font-size: 12px;">RSI: ${h.rsi.toFixed(0)}</div>
                            <div style="color: ${rrColor}; font-size: 11px; margin-top: 2px;">R:R ${h.risk_reward_ratio.toFixed(1)}:1</div>
                            <div style="font-size: 10px; color: var(--text-muted); margin-top: 2px;">BB: ${(h.bb_position * 100).toFixed(0)}%</div>
                        </td>
                    </tr>
                `;
            });

            tbody.innerHTML = html;
        }
    </script>

    <!-- Advanced Trading Chart -->
    <script src="/static/js/advanced-chart.js"></script>
</body>
</html>
