<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>고급 기능 - AutoTrade Pro v4.0</title>

    <!-- TradingView Lightweight Charts -->
    <script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>

    <!-- FullCalendar -->
    <link href='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.9/index.global.min.css' rel='stylesheet' />
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.9/index.global.min.js'></script>

    <!-- Sortable (Drag & Drop) -->
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>

    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            background: #f5f5f7;
            color: #333;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 12px;
            margin-bottom: 30px;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            overflow-x: auto;
        }

        .tab {
            padding: 12px 24px;
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            white-space: nowrap;
        }

        .tab.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .panel {
            display: none;
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .panel.active {
            display: block;
        }

        /* TradingView 차트 */
        #chart-container {
            width: 100%;
            height: 500px;
            background: white;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        /* 전략 빌더 */
        .strategy-builder {
            display: grid;
            grid-template-columns: 250px 1fr 250px;
            gap: 20px;
            min-height: 600px;
        }

        .block-palette {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
        }

        .block {
            background: white;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 8px;
            cursor: move;
            border: 2px solid #e0e0e0;
            transition: all 0.3s;
        }

        .block:hover {
            border-color: #667eea;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.2);
        }

        .block-title {
            font-weight: 600;
            margin-bottom: 5px;
        }

        .block-desc {
            font-size: 12px;
            color: #666;
        }

        .canvas {
            background: #fafafa;
            padding: 20px;
            border-radius: 8px;
            border: 2px dashed #ccc;
            min-height: 400px;
        }

        .properties-panel {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
        }

        /* 캘린더 */
        #calendar {
            max-width: 100%;
        }

        .calendar-event {
            padding: 5px;
            border-radius: 4px;
            margin-bottom: 5px;
            cursor: pointer;
        }

        .event-buy {
            background: #e8f5e9;
            border-left: 4px solid #4caf50;
        }

        .event-sell {
            background: #ffebee;
            border-left: 4px solid #f44336;
        }

        /* 리플레이 컨트롤 */
        .replay-controls {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
        }

        .btn-success {
            background: #4caf50;
            color: white;
        }

        .btn-danger {
            background: #f44336;
            color: white;
        }

        input[type="range"] {
            flex: 1;
            margin: 0 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🚀 고급 기능</h1>
            <p>TradingView 차트, 전략 빌더, 캘린더 일지, 리플레이 시뮬레이션</p>
        </div>

        <div class="tabs">
            <div class="tab active" onclick="switchTab('chart')">📈 인터랙티브 차트</div>
            <div class="tab" onclick="switchTab('builder')">🔧 전략 빌더</div>
            <div class="tab" onclick="switchTab('calendar')">📅 매매 일지</div>
            <div class="tab" onclick="switchTab('replay')">⏯️ 리플레이 시뮬레이션</div>
        </div>

        <!-- 차트 패널 -->
        <div id="panel-chart" class="panel active">
            <h2>TradingView Lightweight Charts</h2>
            <div id="chart-container"></div>
            <div style="margin-top: 20px; display: flex; gap: 10px;">
                <button class="btn btn-primary" onclick="loadChart('005930')">삼성전자</button>
                <button class="btn btn-primary" onclick="loadChart('000660')">SK하이닉스</button>
                <button class="btn btn-primary" onclick="loadChart('035720')">카카오</button>
                <button class="btn btn-success" onclick="addIndicator('MA')">이동평균 추가</button>
                <button class="btn btn-success" onclick="addIndicator('RSI')">RSI 추가</button>
            </div>
        </div>

        <!-- 전략 빌더 패널 -->
        <div id="panel-builder" class="panel">
            <h2>드래그 앤 드롭 전략 빌더</h2>
            <div class="strategy-builder">
                <div class="block-palette">
                    <h3>블록 팔레트</h3>
                    <div id="indicator-blocks">
                        <div class="block" draggable="true" data-type="indicator">
                            <div class="block-title">📊 이동평균선</div>
                            <div class="block-desc">MA(20)</div>
                        </div>
                        <div class="block" draggable="true" data-type="indicator">
                            <div class="block-title">📈 RSI</div>
                            <div class="block-desc">RSI(14)</div>
                        </div>
                        <div class="block" draggable="true" data-type="condition">
                            <div class="block-title">🔍 조건: 이상</div>
                            <div class="block-desc">A > B</div>
                        </div>
                        <div class="block" draggable="true" data-type="condition">
                            <div class="block-title">🔍 조건: 이하</div>
                            <div class="block-desc">A < B</div>
                        </div>
                        <div class="block" draggable="true" data-type="action">
                            <div class="block-title">✅ 매수</div>
                            <div class="block-desc">BUY</div>
                        </div>
                        <div class="block" draggable="true" data-type="action">
                            <div class="block-title">❌ 매도</div>
                            <div class="block-desc">SELL</div>
                        </div>
                    </div>
                </div>

                <div class="canvas" id="strategy-canvas">
                    <p style="text-align: center; color: #999; padding: 50px;">
                        왼쪽에서 블록을 드래그하여 전략을 만드세요
                    </p>
                </div>

                <div class="properties-panel">
                    <h3>블록 속성</h3>
                    <p id="properties-content">블록을 선택하세요</p>
                    <div style="margin-top: 20px;">
                        <button class="btn btn-primary" onclick="saveStrategy()">💾 전략 저장</button>
                        <button class="btn btn-success" onclick="testStrategy()">▶️ 테스트 실행</button>
                        <button class="btn btn-danger" onclick="clearCanvas()">🗑️ 초기화</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 캘린더 패널 -->
        <div id="panel-calendar" class="panel">
            <h2>매매 일지 캘린더</h2>
            <div id="calendar"></div>
        </div>

        <!-- 리플레이 패널 -->
        <div id="panel-replay" class="panel">
            <h2>과거 데이터 리플레이 시뮬레이션</h2>

            <div class="replay-controls">
                <button class="btn btn-primary" onclick="replayPlay()">▶️ 재생</button>
                <button class="btn btn-danger" onclick="replayPause()">⏸️ 일시정지</button>
                <button class="btn btn-primary" onclick="replayStop()">⏹️ 정지</button>
                <label>속도:</label>
                <input type="range" id="replay-speed" min="1" max="100" value="10" onchange="updateSpeed(this.value)">
                <span id="speed-display">10x</span>
            </div>

            <div id="replay-chart-container" style="width: 100%; height: 400px; background: white; border-radius: 8px;">
                <p style="padding: 50px; text-align: center; color: #999;">리플레이를 시작하세요</p>
            </div>
        </div>
    </div>

    <script>
        let chart = null;
        let calendar = null;

        // 탭 전환
        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));

            event.target.classList.add('active');
            document.getElementById('panel-' + tabName).classList.add('active');

            // 캘린더 탭 활성화 시 초기화
            if (tabName === 'calendar' && !calendar) {
                initCalendar();
            }
        }

        // TradingView 차트 초기화
        function initChart() {
            const container = document.getElementById('chart-container');
            chart = LightweightCharts.createChart(container, {
                width: container.clientWidth,
                height: 500,
                layout: {
                    background: { color: '#ffffff' },
                    textColor: '#333',
                },
                grid: {
                    vertLines: { color: '#f0f0f0' },
                    horzLines: { color: '#f0f0f0' },
                },
            });

            loadChart('005930');
        }

        // 차트 데이터 로드
        function loadChart(stockCode) {
            if (!chart) return;

            // 샘플 데이터 생성
            const data = [];
            let basePrice = 70000;
            let baseTime = new Date('2024-01-01').getTime() / 1000;

            for (let i = 0; i < 100; i++) {
                basePrice += (Math.random() - 0.5) * 1000;
                data.push({
                    time: baseTime + i * 86400,
                    open: basePrice,
                    high: basePrice + Math.random() * 2000,
                    low: basePrice - Math.random() * 2000,
                    close: basePrice + (Math.random() - 0.5) * 1000
                });
            }

            const candlestickSeries = chart.addCandlestickSeries();
            candlestickSeries.setData(data);
        }

        // 지표 추가
        function addIndicator(type) {
            alert(type + ' 지표가 추가되었습니다!');
        }

        // 캘린더 초기화
        function initCalendar() {
            const calendarEl = document.getElementById('calendar');
            calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'dayGridMonth,timeGridWeek,timeGridDay'
                },
                events: [
                    {
                        title: '매수: 삼성전자 10주',
                        start: '2024-11-01',
                        className: 'event-buy'
                    },
                    {
                        title: '매도: SK하이닉스 5주',
                        start: '2024-11-05',
                        className: 'event-sell'
                    }
                ],
                eventClick: function(info) {
                    alert('이벤트: ' + info.event.title);
                }
            });
            calendar.render();
        }

        // 드래그 앤 드롭
        function setupDragAndDrop() {
            const canvas = document.getElementById('strategy-canvas');

            document.querySelectorAll('.block').forEach(block => {
                block.addEventListener('dragstart', e => {
                    e.dataTransfer.setData('text/html', e.target.outerHTML);
                });
            });

            canvas.addEventListener('dragover', e => {
                e.preventDefault();
            });

            canvas.addEventListener('drop', e => {
                e.preventDefault();
                const data = e.dataTransfer.getData('text/html');
                const div = document.createElement('div');
                div.innerHTML = data;
                canvas.appendChild(div.firstChild);
            });
        }

        // 전략 저장
        function saveStrategy() {
            alert('전략이 저장되었습니다!');
        }

        // 전략 테스트
        function testStrategy() {
            alert('백테스팅을 시작합니다...');
        }

        // 캔버스 초기화
        function clearCanvas() {
            document.getElementById('strategy-canvas').innerHTML = '<p style="text-align: center; color: #999; padding: 50px;">왼쪽에서 블록을 드래그하여 전략을 만드세요</p>';
        }

        // 리플레이 컨트롤
        function replayPlay() {
            alert('리플레이 시작!');
        }

        function replayPause() {
            alert('일시정지');
        }

        function replayStop() {
            alert('정지');
        }

        function updateSpeed(value) {
            document.getElementById('speed-display').textContent = value + 'x';
        }

        // 페이지 로드
        window.addEventListener('DOMContentLoaded', () => {
            initChart();
            setupDragAndDrop();
        });

        // 창 크기 변경 시 차트 리사이즈
        window.addEventListener('resize', () => {
            if (chart) {
                chart.resize(
                    document.getElementById('chart-container').clientWidth,
                    500
                );
            }
        });
    </script>
</body>
</html>
