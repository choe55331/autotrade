# ✅ 다음 단계: NXT 주문 문제 해결

## 현재 상황

테스트 결과:
- ✅ **현재가 조회 성공** (63.3%)
  - 기본 ka10003 API가 NXT 시간에도 작동합니다
  - 수정 불필요!

- ❌ **주문 실패** (0%)
  - 모든 33개 조합이 실패
  - NXT 시간에 맞는 파라미터를 찾아야 합니다

---

## 🎯 해결 방법

### 1단계: 실패 원인 상세 분석

Windows에서 실행하세요:

```bash
python analyze_order_failures.py test_results_nxt_20251104_190216.json
```

**이 분석으로 확인할 것:**
- 어떤 오류 메시지가 나왔는지
- 어떤 파라미터 조합이 시도되었는지
- NXT 시간에 권장되는 조합은 무엇인지

---

### 2단계: 집중 테스트 실행 ⭐

**다음 NXT 시간대에 실행하세요:**

```bash
# 애프터마켓 시간 (15:30 ~ 20:00) 또는
# 프리마켓 시간 (08:00 ~ 09:00)
python test_nxt_orders_targeted.py
```

**이 테스트의 특징:**
- ✅ NXT 시간대별로 적합한 조합만 테스트
- ✅ 실제 보유종목과 시장가로 테스트
- ✅ 성공 즉시 사용 가능한 코드 생성

**테스트 시간:**
| 시간대 | 테스트 수 | 조합 |
|--------|----------|------|
| 프리마켓 (08:00-09:00) | 5개 | 장전시간외, 시간외단일가 |
| 애프터마켓 (15:30-20:00) | 8개 | 장후시간외, 시간외단일가 |

---

## 예상 결과

### 성공할 가능성이 높은 조합

**애프터마켓 (15:30-20:00):**
```python
# 조합 1 (가장 유력)
dmst_stex_tp = 'NXT'
trde_tp = '16'  # 시간외단일가

# 조합 2
dmst_stex_tp = 'NXT'
trde_tp = '13'  # 장후시간외
```

**프리마켓 (08:00-09:00):**
```python
dmst_stex_tp = 'NXT'
trde_tp = '10'  # 장전시간외
```

---

## 3단계: 코드 적용

집중 테스트에서 성공한 조합이 나오면, `api/order.py`를 수정합니다:

### api/order.py 수정 예시

```python
def buy_stock(self, stock_code: str, quantity: int, price: int) -> Optional[str]:
    """주식 매수"""
    from utils.trading_date import is_nxt_hours

    # NXT 시간대 판별
    if is_nxt_hours():
        # ⭐ 테스트에서 성공한 조합 사용
        now = datetime.now()
        hour = now.hour

        if hour == 8:  # 프리마켓
            dmst_stex_tp = "NXT"
            trde_tp = "10"  # 장전시간외
        else:  # 애프터마켓 (15:30-20:00)
            dmst_stex_tp = "NXT"
            trde_tp = "16"  # 시간외단일가 (테스트 결과에 따라 13으로 변경 가능)
    else:
        # 정규장
        dmst_stex_tp = "KRX"
        trde_tp = "0"  # 지정가

    body = {
        "dmst_stex_tp": dmst_stex_tp,
        "stk_cd": stock_code,
        "ord_qty": str(quantity),
        "ord_uv": str(price),
        "trde_tp": trde_tp
    }

    # ... 나머지 코드
```

---

## 📝 참고: 거래유형 코드

| trde_tp | 설명 | 사용 시간 |
|---------|------|-----------|
| 0 | 지정가 | 정규장 (09:00-15:30) |
| 3 | 시장가 | 정규장 (09:00-15:30) |
| 10 | 장전시간외 | 프리마켓 (08:00-09:00) |
| 13 | 장후시간외 | 애프터마켓 (15:30-20:00) |
| 16 | 시간외단일가 | NXT 시간 (08:00-09:00, 15:30-20:00) |
| 20 | 장전시간외우선 | 프리마켓 (08:00-09:00) |
| 23 | 장후시간외우선 | 애프터마켓 (15:30-20:00) |
| 26 | 시간외단일가우선 | NXT 시간 |

---

## 🚨 주의사항

### 실제 주문 발생!

`test_nxt_orders_targeted.py`는 **실제 주문**을 발생시킵니다.

**안전 장치:**
- ✅ 최소 수량 1주로 테스트
- ✅ 실행 전 확인 프롬프트
- ✅ 보유종목 사용 (있는 경우)

**테스트 전 확인:**
- [ ] 매수가능금액 충분한지
- [ ] 테스트 시간이 NXT 시간대인지
- [ ] 주문 취소 방법 숙지

---

## 💡 트러블슈팅

### Q1: 모든 주문이 "장종료되었습니다" 오류

→ **원인**: 정규장 전용 거래유형 사용 (trde_tp=0, 3 등)
→ **해결**: NXT 전용 거래유형 사용 (10, 13, 16)

### Q2: "매수가능금액 부족" 오류

→ **원인**: 계좌 잔고 부족
→ **해결**:
1. 더 적은 수량으로 테스트
2. 더 낮은 가격으로 테스트

### Q3: "주문불가" 오류

→ **원인**: 종목이 거래정지 상태
→ **해결**: 다른 종목으로 테스트 (예: 삼성전자 005930)

---

## 📞 추가 도움말

1. **실시간 모니터링**
   ```bash
   # 로그 실시간 확인
   tail -f logs/autotrade.log
   ```

2. **주문 내역 확인**
   - 키움증권 HTS/MTS에서 주문 내역 확인
   - 주문번호로 체결 여부 확인

3. **주문 취소** (필요시)
   - 키움증권 앱에서 미체결 주문 취소

---

## ✅ 체크리스트

- [ ] 1단계: `analyze_order_failures.py` 실행
- [ ] 실패 원인 파악
- [ ] 2단계: NXT 시간에 `test_nxt_orders_targeted.py` 실행
- [ ] 성공한 조합 기록
- [ ] 3단계: `api/order.py` 수정
- [ ] main.py 재시작
- [ ] NXT 시간에 실제 매수 테스트
- [ ] ✅ 성공!

---

**다음 NXT 시간:**
- 내일 프리마켓: 08:00 ~ 09:00
- 오늘/내일 애프터마켓: 15:30 ~ 20:00

**지금 바로 할 수 있는 것:**
```bash
python analyze_order_failures.py test_results_nxt_20251104_190216.json
```

이것으로 실패 원인을 먼저 파악하세요! 🔍
